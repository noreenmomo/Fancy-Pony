<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fancy Pony — Text-only Submissions</title>
<style>
  :root { color-scheme: light; }
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:#fff url("https://i.postimg.cc/jSmGH445/Pony.png") repeat center top;
    background-size: 220px auto;
  }
  .wrap{
    width:70%;
    margin: 24px auto 80px;
  }
  .card{
    background:#ffffffcc;
    backdrop-filter: blur(2px);
    border: 1px solid #e5e7eb;
    border-radius: 14px;
    box-shadow: 0 10px 20px rgba(0,0,0,.05);
    padding: 18px;
  }
  h1{
    margin: 0 0 12px;
    font-size: 28px;
    letter-spacing:.3px;
  }
  label{ display:block; font-weight:600; margin: 10px 0 6px; }
  input[type="text"],input[type="email"],textarea{
    width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:10px; font-size:15px;
    background:#fff;
  }
  input[type="file"]{ width:100%; }
  textarea{ min-height:120px; resize: vertical; }
  .muted{ color:#6b7280; font-size:12px; }
  .row{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .row > div { min-width:0; }
  .actions{ display:flex; align-items:center; gap:12px; margin-top:12px; }
  button{
    appearance:none; border:0; border-radius:10px; padding:10px 16px; font-weight:700;
    background:#2563eb; color:#fff; cursor:pointer;
  }
  button[disabled]{ opacity:.6; cursor:not-allowed; }
  .ok{ color:#065f46; background:#ecfdf5; border:1px solid #d1fae5; padding:8px 10px; border-radius:10px;}
  .warn{ color:#92400e; background:#fff7ed; border:1px solid #ffedd5; padding:8px 10px; border-radius:10px;}
  .err{ color:#991b1b; background:#fef2f2; border:1px solid #fee2e2; padding:8px 10px; border-radius:10px;}
  .progress{
    height:8px; background:#f3f4f6; border-radius:999px; overflow:hidden; margin-top:6px;
  }
  .bar{ height:100%; width:0%; background:#10b981; transition: width .2s ease; }
  .list{ display:flex; flex-direction:column; gap:10px; }
  .item{
    background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:14px;
  }
  .item h3{ margin:0 0 6px; font-size:16px; }
  .meta{ font-size:12px; color:#6b7280; display:flex; gap:10px; flex-wrap:wrap; }
  .desc{ font-size:14px; color:#374151; margin-top:6px; white-space:pre-wrap; }
  .right { text-align:right; }
  a:link,a:visited{ color:#2563eb; text-decoration: underline; }
  @media (max-width: 900px){
    .wrap{ width:92%; }
    .row{ grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Fancy Pony — Artwork Submission</h1>
      <div class="muted" id="total">Total drawings collected: …</div>

      <form id="ponyForm" class="mt">
        <div class="row">
          <div>
            <label>Your Name *</label>
            <input id="name" name="name" type="text" required />
          </div>
          <div>
            <label>Your Email *</label>
            <input id="email" name="email" type="email" required />
          </div>
        </div>

        <label>Pony Name *</label>
        <input id="title" name="title" type="text" required />

        <label>Upload File *</label>
        <input id="file" name="file" type="file" accept=".jpg,.jpeg,.png,.pdf" required />
        <div class="muted">File size must be between <b>1 MB</b> and <b>5 MB</b>. Recommended: <b>150–300 ppi</b> (Letter size scan typically &gt; 1 MB).</div>

        <label>Description (optional)</label>
        <textarea id="description" name="description" placeholder="Tell us about your pony…"></textarea>

        <label class="ck">
          <input id="consent" name="consent" type="checkbox" value="true" required />
          I agree to grant the school marketing rights to print, publicly display, and use my artwork for creative purposes.
        </label>

        <div class="actions">
          <button id="submitBtn" type="submit">Upload</button>
          <div id="status" class="muted">Ready.</div>
        </div>
        <div class="progress"><div id="bar" class="bar"></div></div>
      </form>
    </div>

    <div class="card" style="margin-top:16px;">
      <h2 style="margin:0 0 10px;">Recent submissions</h2>
      <div id="list" class="list">Loading…</div>
      <div class="right"><a id="viewAll" href="javascript:void(0)">refresh</a></div>
    </div>
  </div>

<script>
/** === YOUR WEB APP URL ( /exec ) === **/
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzqnplLlJsrf1rgLQmocmeLOTmyub-tj6jNeaMscqG5v7QfxuDZ_sR-D8sjLv3fDPkO_w/exec';

/** ========== small helpers ========== */
const $ = id => document.getElementById(id);
function setStatus(msg, cls='muted'){ const s=$('status'); s.className=cls; s.textContent=msg; }
function setBar(p){ $('bar').style.width = Math.max(0,Math.min(100, p)) + '%'; }
function fmtTime(v){
  try{ const d = new Date(v); return d.toLocaleString(); }catch{ return String(v||''); }
}

/** === fetch count & list (text only) === */
async function refreshCount(){
  try{
    const r = await fetch(SCRIPT_URL + '?action=count', { cache:'no-store' });
    const j = await r.json();
    $('total').textContent = 'Total drawings collected: ' + (j.count ?? 0);
  }catch{ $('total').textContent = 'Total drawings collected: —'; }
}
async function refreshList(){
  try{
    const r = await fetch(SCRIPT_URL + '?action=list&limit=20', { cache:'no-store' });
    const j = await r.json();
    const box = $('list');
    if (!j.ok){ box.textContent = 'Failed to load.'; return; }
    const items = Array.isArray(j.items)? j.items : [];
    if (!items.length){ box.textContent = 'No items yet.'; return; }
    box.innerHTML = '';
    for (const it of items){
      const title = (it.title ?? '').toString() || 'Untitled';
      const name  = (it.name  ?? '').toString() || '—';
      const desc  = (it.description ?? it.desc ?? '').toString();
      const when  = fmtTime(it.timestamp);
      const url   = (it.fileUrl ?? '').toString();
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <h3>${escapeHtml(title)}</h3>
        <div class="meta">
          <span>by ${escapeHtml(name)}</span>
          ${when ? `<span>• ${escapeHtml(when)}</span>`:''}
          ${url ? `<span>• <a href="${url}" target="_blank" rel="noopener">Open file</a></span>`:''}
        </div>
        ${desc ? `<div class="desc">${escapeHtml(desc)}</div>`:''}
      `;
      box.appendChild(div);
    }
  }catch(e){
    $('list').textContent = 'Failed to fetch';
  }
}
function escapeHtml(s){
  return String(s||'')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

/** === hidden-iframe base64 submit (CORS-safe) === */
function postViaIframe(fields){
  return new Promise(resolve=>{
    const iframe = document.createElement('iframe');
    iframe.name  = 'pony_iframe_' + Math.random().toString(36).slice(2);
    iframe.style.display = 'none';
    document.body.appendChild(iframe);

    const form = document.createElement('form');
    form.action = SCRIPT_URL;
    form.method = 'POST';
    form.target = iframe.name;
    form.enctype = 'application/x-www-form-urlencoded'; // 保險
    for (const [k,v] of Object.entries(fields)){
      const input = document.createElement('input');
      input.type = 'hidden'; input.name = k; input.value = v;
      form.appendChild(input);
    }
    document.body.appendChild(form);

    const cleanup = () => { setTimeout(()=>{ form.remove(); iframe.remove(); }, 50); };

    iframe.addEventListener('load', ()=>{ cleanup(); resolve(true); });
    form.submit();
  });
}

/** === read file to base64 with progress === */
function fileToBase64WithProgress(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onprogress = ev=>{
      if (ev.lengthComputable){
        const pct = Math.round( (ev.loaded/ev.total)*100 );
        setBar(pct);
        setStatus(`Reading file… ${pct}%`);
      }
    };
    fr.onload = ()=>{
      const s = String(fr.result||''); const i = s.indexOf('base64,');
      resolve(i>=0 ? s.slice(i+7) : s);
    };
    fr.onerror = ()=> reject(fr.error || new Error('read error'));
    fr.readAsDataURL(file);
  });
}

/** === main submit === */
$('ponyForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const btn = $('submitBtn');
  try{
    btn.disabled = true; setBar(0); setStatus('Preparing…');

    const name  = $('name').value.trim();
    const email = $('email').value.trim();
    const title = $('title').value.trim();
    const desc  = $('description').value.trim();
    const consent = $('consent').checked ? 'true' : 'false';
    const file = $('file').files[0];
    if (!file){ setStatus('Please choose a file.', 'err'); btn.disabled=false; return; }

    // 讀檔 + 上傳
    const b64 = await fileToBase64WithProgress(file);
    setStatus('Uploading (safe fallback)…'); setBar(100);

    const beforeCount = await getCountSafe();
    await postViaIframe({
      name, email, title, description: desc, consent,
      filebase64: b64, mimetype: file.type || 'application/octet-stream',
      filename: file.name || 'upload.bin'
    });

    // 嘗試輪詢確認是否寫入
    setStatus('Upload sent. Waiting for confirmation…','warn');
    const ok = await waitForCountIncrease(beforeCount, 6, 2000);
    if (ok){
      setStatus('Upload successful!','ok');
      e.target.reset();
      await refreshCount();
      await refreshList();
    }else{
      setStatus('Upload sent but not confirmed yet. Please check later.','warn');
      // 仍刷新一次（有時 count 延遲，但 item 已寫入）
      await refreshCount(); await refreshList();
    }
  }catch(err){
    console.error(err);
    setStatus('Upload failed: ' + (err.message||err),'err');
  }finally{
    btn.disabled = false; setTimeout(()=>setBar(0), 800);
  }
});

/** === polling helpers === */
async function getCountSafe(){
  try{
    const r = await fetch(SCRIPT_URL + '?action=count', { cache:'no-store' });
    const j = await r.json(); return j.count ?? 0;
  }catch{ return 0; }
}
async function waitForCountIncrease(oldCount, tries=6, gap=2000){
  for (let i=0;i<tries;i++){
    await new Promise(r=>setTimeout(r,gap));
    const now = await getCountSafe();
    if (now > oldCount) return true;
  }
  return false;
}

/** === initial === */
refreshCount();
refreshList();
$('viewAll').addEventListener('click', ()=> refreshList());
</script>
</body>
</html>
