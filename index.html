<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fancy Pony — Artwork Submission</title>
<style>
  :root{color-scheme:light;}
  body{
    margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background:#fff url("https://i.postimg.cc/jSmGH445/Pony.png") repeat;
    background-size:120px 120px;
  }
  .wrap{max-width:760px; margin:36px auto; padding:16px;}
  .card{
    background:#fff; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.08);
    padding:18px; margin-bottom:16px;
  }
  h1{margin:0 0 12px; font-size:28px}
  label{font-weight:600; display:block; margin:.6rem 0 .25rem}
  input[type=text],input[type=email],textarea{
    width:100%; padding:.65rem .75rem; border:1px solid #d1d5db; border-radius:10px; font:inherit;
    background:#f8fafc;
  }
  textarea{min-height:110px; resize:vertical}
  input[type=file]{width:100%}
  .row{display:grid; grid-template-columns:1fr; gap:12px}
  .muted{color:#6b7280; font-size:12px}
  .checkbox{display:flex; align-items:flex-start; gap:.6rem; margin-top:.5rem}
  .btn{
    display:inline-flex; align-items:center; gap:.5rem; padding:.7rem 1.1rem; border:0; border-radius:10px;
    background:#2563eb; color:#fff; font-weight:700; cursor:pointer;
  }
  .btn[disabled]{opacity:.5; cursor:not-allowed}
  .ok{background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; padding:.6rem .8rem; border-radius:10px}
  .err{background:#fef2f2; color:#991b1b; border:1px solid #fecaca; padding:.6rem .8rem; border-radius:10px}
  .list{list-style:none; padding:0; margin:0}
  .item{padding:12px 0; border-top:1px solid #e5e7eb}
  .item:first-child{border-top:0}
  .item h3{margin:0 0 4px; font-size:16px}
  .meta{color:#6b7280; font-size:12px}
  .flex{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Fancy Pony — Artwork Submission</h1>
      <div class="flex">
        <div class="muted">Total drawings collected: <span id="count">—</span></div>
        <div class="muted" id="backendMeta"></div>
      </div>
    </div>

    <div class="card">
      <form id="uploadForm" novalidate>
        <label>Your Name *</label>
        <input id="name" name="name" type="text" required />

        <label>Your Email *</label>
        <input id="email" name="email" type="email" required />

        <label>Pony Name *</label>
        <input id="title" name="title" type="text" required />

        <label>Upload File *</label>
        <input id="file" name="file" type="file" accept=".jpg,.jpeg,.png,.pdf" required />
        <div class="muted">File size must be between <b>1 MB</b> and <b>5 MB</b>. Recommended: <b>150–300 ppi</b> (Letter size scans are typically &gt; 1 MB).</div>

        <label>Description (optional)</label>
        <textarea id="description" name="description" placeholder="Tell us about your pony…"></textarea>

        <div class="checkbox">
          <input id="consent" name="consent" type="checkbox" value="true" required />
          <label for="consent" style="margin:0;font-weight:400;">I agree to grant the school marketing rights to print, publicly display, and use my artwork for creative purposes.</label>
        </div>

        <div class="flex" style="margin-top:12px">
          <button id="btn" class="btn" type="submit">Upload</button>
          <span id="status" class="muted"></span>
        </div>
      </form>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px">Latest submissions</h2>
      <ul id="list" class="list"><li class="muted">Loading…</li></ul>
    </div>
  </div>

<script>
  // CHANGE THIS to your current /exec URL
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyS8EeAEoACk6HqauFS1y44kI7j20xmuTmIJPucYmtnCBBBSiQu_uSZ8vJGftIaHueFvA/exec';

  const $ = id => document.getElementById(id);

  /* ---------- helpers ---------- */
  function toBase64(file){
    return new Promise((res, rej)=>{
      const r = new FileReader();
      r.onload = () => res(String(r.result).split('base64,').pop());
      r.onerror = () => rej(r.error || new Error('read error'));
      r.readAsDataURL(file);
    });
  }
  function fmtTime(ts){
    try{
      const d = new Date(ts);
      return d.toLocaleString();
    }catch{ return String(ts||''); }
  }

  async function refreshCount(){
    try{
      const r = await fetch(SCRIPT_URL + '?action=count', {cache:'no-store'});
      const j = await r.json();
      if (j.ok){
        $('count').textContent = j.count ?? 0;
        $('backendMeta').textContent = j.version ? `backend: ${j.version}` : '';
      }
    }catch{}
  }

  async function refreshList(){
    const box = $('list');
    box.innerHTML = '<li class="muted">Loading…</li>';
    try{
      const r = await fetch(SCRIPT_URL + '?action=list', {cache:'no-store'});
      const j = await r.json();
      if (!j.ok){ box.innerHTML = `<li class="err">Failed: ${j.error||'Unknown error'}</li>`; return; }
      const items = Array.isArray(j.items) ? j.items : [];
      if (items.length === 0){ box.innerHTML = '<li class="muted">No items yet.</li>'; return; }
      box.innerHTML = '';
      items.forEach(it=>{
        const li = document.createElement('li');
        li.className = 'item';
        const title = (it.title || 'Untitled').toString();
        const name  = (it.name  || '').toString();
        const desc  = (it.description || '').toString(); // may be empty in old rows
        const when  = fmtTime(it.timestamp);
        const link  = it.fileId ? `${SCRIPT_URL}?action=img&id=${encodeURIComponent(it.fileId)}`
                                : (it.directUrl || it.fileUrl || '#');
        li.innerHTML = `
          <h3>${title}</h3>
          <div class="meta">${name ? `by <b>${name}</b> • ` : ''}${when}</div>
          ${desc ? `<div style="margin:.4rem 0">${desc.replace(/</g,'&lt;')}</div>` : ''}
          <div><a href="${link}" target="_blank" rel="noopener">Open file</a></div>
        `;
        box.appendChild(li);
      });
    }catch(e){
      box.innerHTML = `<li class="err">Error: ${e.message}</li>`;
    }
  }

  /* ---------- upload flow (multipart first, base64 fallback) ---------- */
  $('uploadForm').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const btn = $('btn');
    const st  = $('status');
    const f   = $('file').files[0];

    // basic validation
    if (!f){ st.textContent = 'Error: No file selected'; st.className='err'; return; }
    if (f.size < 1*1024*1024 || f.size > 5*1024*1024){
      st.textContent = 'Error: File must be between 1MB and 5MB';
      st.className='err'; return;
    }
    if (!$('consent').checked){
      st.textContent = 'Please agree to the consent.'; st.className='err'; return;
    }

    btn.disabled = true; st.textContent = 'Uploading…'; st.className='muted';

    // 1) try multipart (best for Apps Script)
    try{
      const fd = new FormData();
      fd.append('name', $('name').value.trim());
      fd.append('email', $('email').value.trim());
      fd.append('title', $('title').value.trim());
      fd.append('description', $('description').value.trim());
      fd.append('consent', $('consent').checked ? 'true' : 'false');
      fd.append('file', f, f.name); // critical: field name must be 'file'

      const r = await fetch(SCRIPT_URL, { method:'POST', body: fd });
      const j = await r.json();

      if (j.ok){
        st.innerHTML = `<span class="ok">Upload successful.</span>`;
        ev.target.reset();
        await refreshCount();
        await refreshList();
        btn.disabled = false;
        return;
      } else if (j.error && /no file/i.test(j.error)){
        // fall through to base64 path
      } else {
        throw new Error(j.error || 'Upload failed');
      }
    }catch(_){ /* fall back */ }

    // 2) fallback: base64
    try{
      const b64 = await toBase64(f);
      const fd2 = new FormData();
      fd2.append('name', $('name').value.trim());
      fd2.append('email', $('email').value.trim());
      fd2.append('title', $('title').value.trim());
      fd2.append('description', $('description').value.trim());
      fd2.append('consent', $('consent').checked ? 'true' : 'false');
      fd2.append('filebase64', b64);
      fd2.append('mimetype', f.type || 'application/octet-stream');
      fd2.append('filename', f.name || 'upload.bin');

      const r2 = await fetch(SCRIPT_URL, { method:'POST', body: fd2 });
      const j2 = await r2.json();

      if (j2.ok){
        st.innerHTML = `<span class="ok">Upload successful.</span>`;
        ev.target.reset();
        await refreshCount();
        await refreshList();
      }else{
        throw new Error(j2.error || 'Upload failed');
      }
    }catch(err){
      st.innerHTML = `<span class="err">Error: ${err.message}</span>`;
    }finally{
      btn.disabled = false;
    }
  });

  refreshCount();
  refreshList();
</script>
</body>
</html>
