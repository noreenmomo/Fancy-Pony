<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fancy Pony — Artwork Submission</title>
<style>
  :root { color-scheme: light; }
  body{
    margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background-image:url("https://i.postimg.cc/jSmGH445/Pony.png");
    background-repeat:repeat;
    background-size:140px auto; /* small repeating ponies */
  }
  .wrap{ max-width: 920px; margin: 32px auto; padding: 24px; }
  .cardish{
    background:#fff; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.08);
    padding:20px;
  }
  h1{ margin:0 0 8px; font-size: clamp(28px, 4vw, 36px); }
  .muted{ color:#6b7280; }
  label{ display:block; font-weight:600; margin:14px 0 6px; }
  input[type="text"], input[type="email"], textarea, input[type="file"]{
    width:100%; padding:.7rem .75rem; border:1px solid #d1d5db; border-radius:10px; font-size:16px;
    background:#fff;
  }
  textarea{ resize:vertical; min-height:110px; }
  .row{ display:grid; grid-template-columns: 1fr; gap:14px; }
  .consent{ display:flex; gap:.6rem; align-items:flex-start; margin-top:10px; }
  .consent input{ margin-top:.2rem; }
  button{
    display:inline-flex; gap:.5rem; align-items:center;
    margin-top:14px; padding:.75rem 1.1rem;
    background:#2563eb; color:#fff; border:0; border-radius:10px; font-weight:700; cursor:pointer;
    box-shadow:0 6px 18px rgba(37,99,235,.25);
  }
  button[disabled]{ opacity:.6; cursor:not-allowed; }
  .spinner{ width:16px; height:16px; border:2px solid #fff; border-right-color:transparent; border-radius:50%; animation:spin .8s linear infinite; }
  @keyframes spin{ to { transform:rotate(360deg); } }

  .status{ margin-top:10px; min-height:20px; }
  .ok{ color:#065f46; background:#ecfdf5; border:1px solid #a7f3d0; padding:8px 10px; border-radius:8px; display:inline-block; }
  .err{ color:#991b1b; background:#fef2f2; border:1px solid #fecaca; padding:8px 10px; border-radius:8px; display:inline-block; }

  .bar{ margin:18px 0 10px; display:flex; justify-content:space-between; align-items:center; }
  .count{ font-weight:600; }

  /* gallery */
  .galleryWrap{ margin-top:18px; }
  .gTitle{ text-align:center; font-weight:800; font-size: clamp(22px, 3vw, 28px); margin: 8px 0 14px; }
  #galleryError{ color:#b91c1c; margin-bottom:8px; }
  .grid{
    display:grid;
    grid-template-columns: repeat(auto-fill,minmax(220px,1fr));
    gap:16px;
  }
  figure.card{
    background:#fff; border-radius:14px; box-shadow:0 8px 22px rgba(0,0,0,.06); margin:0; overflow:hidden;
    display:flex; flex-direction:column; min-height:280px;
  }
  figure.card img{
    width:100%; height:200px; object-fit:cover; background:#f3f4f6; display:block;
  }
  figure.card figcaption{ padding:10px 12px; }
  .title{ font-weight:700; }
  .by{ color:#6b7280; }
  .desc{ margin-top:4px; color:#374151; font-size:14px; line-height:1.25; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="cardish">
      <h1>Fancy Pony — Artwork Submission</h1>
      <div class="muted" id="meta"></div>

      <div class="row" style="margin-top:8px;">
        <label>Your Name *<input id="name" type="text" required></label>
        <label>Your Email *<input id="email" type="email" required></label>
        <label>Pony Name *<input id="title" type="text" required></label>
      </div>

      <label>Upload File *<input id="file" type="file" accept=".jpg,.jpeg,.png,.pdf" required></label>
      <div class="muted">File size must be between <b>1 MB</b> and <b>5 MB</b>. Recommended: <b>150–300 ppi</b> (Letter size scans are typically &gt; 1 MB).</div>

      <label>Description (optional)
        <textarea id="description" placeholder="Tell us about your pony…"></textarea>
      </label>

      <div class="consent">
        <input id="consent" type="checkbox" value="true" />
        <label for="consent" style="margin:0;font-weight:500;">I agree to grant the school marketing rights to print, publicly display, and use my artwork for creative purposes.</label>
      </div>

      <button id="btn"><span class="btnText">Upload</span></button>
      <div class="status" id="status"></div>

      <div class="bar">
        <div class="count">Total drawings collected: <span id="count">—</span></div>
      </div>
    </div>

    <div class="cardish galleryWrap">
      <div class="gTitle">Gallery</div>
      <div id="galleryError"></div>
      <div id="gallery" class="grid"></div>
    </div>
  </div>

<script>
  // ==== CONFIG: replace with your latest /exec URL ====
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyS8EeAEoACk6HqauFS1y44kI7j20xmuTmIJPucYmtnCBBBSiQu_uSZ8vJGftIaHueFvA/exec';

  // small helpers
  const $ = id => document.getElementById(id);
  const S = v => (v === null || v === undefined) ? '' : String(v);

  function setBusy(busy){
    const btn = $('btn');
    const t = btn.querySelector('.btnText');
    if (busy){
      btn.setAttribute('disabled','disabled');
      t.innerHTML = '<span class="spinner"></span> Uploading…';
    } else{
      btn.removeAttribute('disabled');
      t.textContent = 'Upload';
    }
  }

  function toBase64(file){
    return new Promise((res,rej)=>{
      const fr = new FileReader();
      fr.onload = () => {
        const s = String(fr.result||'');
        const i = s.indexOf('base64,');
        res(i>=0 ? s.slice(i+7) : s);
      };
      fr.onerror = () => rej(fr.error || new Error('read error'));
      fr.readAsDataURL(file);
    });
  }

  async function fetchJSON(url, opts){
    const r = await fetch(url, opts);
    const text = await r.text();
    try { return JSON.parse(text); } catch { throw new Error('Bad JSON: '+text.slice(0,200)); }
  }

  async function refreshCount(){
    try{
      const j = await fetchJSON(SCRIPT_URL + '?action=count&cache=' + Date.now());
      $('count').textContent = j.ok ? (j.count ?? 0) : '—';
      $('meta').textContent = j.ok ? `${j.version || ''} ${j.marker || ''}`.trim() : '';
    }catch(e){
      $('count').textContent = '—';
    }
  }

  async function refreshGallery(){
    const box = $('gallery'), errBox = $('galleryError');
    errBox.textContent = '';
    box.innerHTML = '<div class="muted" style="padding:8px;">Loading…</div>';

    let data;
    try{
      data = await fetchJSON(`${SCRIPT_URL}?action=list&limit=50&cache=${Date.now()}`);
      if (!data.ok) throw new Error(data.error || 'list failed');
    }catch(e){
      try{
        data = await fetchJSON(`${SCRIPT_URL}?action=drive_list&limit=50&cache=${Date.now()}`);
        if (!data.ok) throw new Error(data.error || 'drive_list failed');
      }catch(e2){
        box.innerHTML = '';
        errBox.textContent = 'Failed to fetch';
        console.error('gallery failed:', e, e2);
        return;
      }
    }

    const items = Array.isArray(data.items) ? data.items : [];
    if (!items.length){
      box.innerHTML = '<div class="muted" style="padding:8px;">No items yet.</div>';
      return;
    }

    box.innerHTML = '';
    items.forEach(it=>{
      const title = S(it.title).trim();
      const name  = S(it.name).trim();
      const desc  = S(it.description).trim();
      const src   = S(it.imgUrl) || S(it.directUrl) || S(it.fileUrl);

      const card = document.createElement('figure');
      card.className='card';
      card.innerHTML = `
        <img loading="lazy"
             src="${src}"
             alt="${title || 'Artwork'}"
             referrerpolicy="no-referrer"
             onerror="this.onerror=null; this.src='${S(it.fileUrl)}'; this.style.objectFit='contain';">
        <figcaption>
          <div class="title">${title || 'Untitled'}</div>
          ${name ? `<div class="by">by ${name}</div>` : ``}
          ${desc ? `<div class="desc">${desc}</div>` : ``}
        </figcaption>
      `;
      box.appendChild(card);
    });
  }

  async function upload(){
    const status = $('status');
    status.textContent = '';
    const name = $('name').value.trim();
    const email= $('email').value.trim();
    const title= $('title').value.trim();
    const desc = $('description').value.trim();
    const file = $('file').files[0];
    const consent = $('consent').checked;

    if (!name || !email || !title){ status.innerHTML = '<span class="err">Please fill in required fields.</span>'; return; }
    if (!file){ status.innerHTML = '<span class="err">Please choose a file.</span>'; return; }
    if (!consent){ status.innerHTML = '<span class="err">Please agree to the consent.</span>'; return; }

    // size check 1–5 MB
    const sizeMB = file.size/1024/1024;
    if (sizeMB < 1 || sizeMB > 5){
      status.innerHTML = '<span class="err">File size must be between 1 MB and 5 MB.</span>';
      return;
    }

    setBusy(true);
    try{
      // 1) Try multipart
      const fd = new FormData();
      fd.append('name', name);
      fd.append('email', email);
      fd.append('title', title);
      fd.append('description', desc);
      fd.append('consent', consent ? 'true' : 'false');
      fd.append('file', file, file.name); // critical name

      let data;
      try{
        data = await fetchJSON(SCRIPT_URL, { method:'POST', body: fd });
      }catch(e){
        // network layer failed; try base64 path
        data = { ok:false, error:String(e) };
      }

      // 2) If backend says "No file uploaded", use base64 fallback
      if (!data.ok && data.error && /No file uploaded/i.test(data.error)){
        const b64 = await toBase64(file);
        const fd2 = new FormData();
        fd2.append('name', name);
        fd2.append('email', email);
        fd2.append('title', title);
        fd2.append('description', desc);
        fd2.append('consent', consent ? 'true' : 'false');
        fd2.append('filebase64', b64);
        fd2.append('mimetype', file.type || 'application/octet-stream');
        fd2.append('filename', file.name || 'upload.bin');
        data = await fetchJSON(SCRIPT_URL, { method:'POST', body: fd2 });
      }

      if (data.ok){
        status.innerHTML = `<span class="ok">Upload successful.</span>`;
        // clear form
        $('description').value = '';
        $('file').value = '';
        $('title').focus();
        await refreshCount();
        await refreshGallery();
      }else{
        const diag = data.diag ? `<pre class="muted" style="white-space:pre-wrap;margin-top:6px;">${JSON.stringify(data.diag,null,2)}</pre>` : '';
        status.innerHTML = `<span class="err">Upload failed: ${S(data.error)||'Unknown error'}</span>${diag}`;
      }
    }catch(err){
      status.innerHTML = `<span class="err">Error: ${err.message}</span>`;
      console.error(err);
    }finally{
      setBusy(false);
    }
  }

  $('btn').addEventListener('click', upload);
  refreshCount();
  refreshGallery();
</script>
</body>
</html>
