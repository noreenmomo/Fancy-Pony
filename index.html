<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fancy Pony – Art Submission</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: url('https://i.postimg.cc/jSmGH445/Pony.png') repeat;
    margin: 0;
    padding: 0;
  }
  h1, h2 { text-align: center; color: #333; }
  form {
    background: #fff;
    max-width: 70%;
    margin: 20px auto;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  label { display: block; margin-top: .5rem; }
  input[type="text"], input[type="email"], input[type="file"], textarea {
    width: 100%; padding: .5rem; margin-top: .3rem;
    border: 1px solid #ccc; border-radius: 4px;
  }
  textarea { resize: vertical; }
  button {
    margin-top: 1rem; padding: 0.6rem 1.2rem;
    background: #2563eb; color: white; border: none; border-radius: 4px;
    cursor: pointer;
  }
  button:hover { background: #1e40af; }
  .consent { display: flex; align-items: flex-start; gap: .5rem; margin-top: 1rem; }
  #status { text-align: center; margin-top: 1rem; font-weight: bold; }
  #gallery.grid {
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
    gap:12px;
    max-width: 90%;
    margin: 20px auto;
  }
  .card {
    background:#fff; border-radius:10px; box-shadow:0 1px 4px rgba(0,0,0,.08); overflow:hidden
  }
  .card img {
    width:100%; height:180px; object-fit:cover; display:block
  }
  .card figcaption { padding:8px 10px; font-size:14px }
  .card .by { color:#6b7280; font-size:12px }
  .muted { color:#6b7280; text-align:center; }
</style>
</head>
<body>

<h1>Fancy Pony Art Submission</h1>

<form id="uploadForm">
  <label for="name">Your Name *</label>
  <input type="text" id="name" name="name" required>

  <label for="email">Your Email *</label>
  <input type="email" id="email" name="email" required>

  <label for="title">Pony Name *</label>
  <input type="text" id="title" name="title" required>

  <label for="file">Upload File *</label>
  <input type="file" id="file" name="file" accept="image/*" required>
  <small>File size must be between 1 MB and 5 MB.</small>

  <label for="description">Description (optional)</label>
  <textarea id="description" name="description"></textarea>

  <div class="consent">
    <input type="checkbox" id="consent" name="consent" value="true" required>
    <label for="consent">I agree to grant the school marketing rights to print, publicly display, and use my artwork for creative purposes.</label>
  </div>

  <button type="submit">Upload</button>
</form>

<div id="status"></div>

<h2>Gallery</h2>
<div id="gallery" class="grid"></div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyS8EeAEoACk6HqauFS1y44kI7j20xmuTmIJPucYmtnCBBBSiQu_uSZ8vJGftIaHueFvA/exec'; // Replace with your deployed Apps Script URL

document.getElementById('uploadForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const status = document.getElementById('status');
  status.textContent = 'Uploading...';

  const fileInput = document.getElementById('file');
  const file = fileInput.files[0];
  if (!file) {
    status.textContent = 'Please select a file.';
    return;
  }
  if (file.size < 1*1024*1024 || file.size > 5*1024*1024) {
    status.textContent = 'File size must be between 1 MB and 5 MB.';
    return;
  }

  const formData = new FormData(this);
  try {
    const res = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
    const json = await res.json();
    if (json.ok) {
      status.textContent = 'Upload successful!';
      this.reset();
      await loadGallery(true);
    } else {
      status.textContent = 'Error: ' + (json.error || 'Unknown error');
    }
  } catch (err) {
    console.error(err);
    status.textContent = 'Upload failed.';
  }
});

async function loadGallery(force = false) {
  const box = document.getElementById('gallery');
  box.innerHTML = 'Loading…';

  const fetchJSON = async (action) => {
    const url = `${SCRIPT_URL}?action=${action}&limit=48&t=${Date.now()}`;
    const r = await fetch(url, { cache: 'no-store' });
    return r.ok ? r.json() : { ok:false, error:`HTTP ${r.status}` };
  };

  let res = await fetchJSON('list');
  if (!res.ok || !res.items || res.items.length === 0) {
    res = await fetchJSON('drive_list');
  }

  if (!res.ok) {
    box.innerHTML = `<div style="color:#b91c1c">Failed to load gallery: ${res.error || 'Unknown error'}</div>`;
    console.error('gallery error', res);
    return;
  }

  const items = res.items || [];
  if (items.length === 0) {
    box.innerHTML = '<div class="muted">No items yet.</div>';
    return;
  }

  box.innerHTML = '';
  items.forEach(it => {
    const src = it.directUrl || it.fileUrl;
    const title = (it.title || '').trim();
    const name = (it.name || '').trim();
    const card = document.createElement('figure');
    card.className = 'card';
    card.innerHTML = `
      <img loading="lazy" src="${src}" alt="${title || 'Artwork'}">
      <figcaption>${title || 'Untitled'}${name ? ` <span class="by">by ${name}</span>` : ''}</figcaption>
    `;
    box.appendChild(card);
  });
}

loadGallery();
</script>

</body>
</html>
