<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Fancy Pony Drawing Upload</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 800px; margin: auto; padding: 20px; }
  h1 { text-align: center; }
  .form-group { margin-bottom: 15px; }
  label { display: block; font-weight: bold; margin-bottom: 5px; }
  input[type="text"], input[type="email"], input[type="file"] { width: 100%; padding: 8px; }
  button { padding: 10px 20px; font-size: 16px; }
  button[disabled] { background: #ccc; cursor: not-allowed; }
  .loading { display: inline-block; margin-left: 10px; }
  .loading span { display: inline-block; width: 8px; height: 8px; margin: 0 2px; background: #333; border-radius: 50%; animation: bounce 0.6s infinite alternate; }
  .loading span:nth-child(2) { animation-delay: 0.2s; }
  .loading span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes bounce { to { transform: translateY(-8px); } }
  .success { color: green; margin-top: 10px; font-weight: bold; }
  .error { color: red; margin-top: 10px; font-weight: bold; }
  .gallery { display: grid; grid-template-columns: repeat(auto-fill,minmax(150px,1fr)); gap: 10px; margin-top: 20px; }
  .gallery img { width: 100%; height: auto; border: 1px solid #ccc; }
  .count { font-weight: bold; margin-bottom: 20px; }
</style>
</head>
<body>

<h1>Fancy Pony Drawing Upload</h1>
<div class="count">Loading count...</div>

<form id="uploadForm">
  <div class="form-group">
    <label for="name">Your Name *</label>
    <input type="text" id="name" name="name" required>
  </div>

  <div class="form-group">
    <label for="email">Your Email *</label>
    <input type="email" id="email" name="email" required>
  </div>

  <div class="form-group">
    <label for="title">Pony Name *</label>
    <input type="text" id="title" name="title" required>
  </div>

  <div class="form-group">
    <label for="file">Upload File *</label>
    <input type="file" id="file" name="file" accept="image/*" required>
    <small>File size must be between 1MB and 3MB. Recommended: 150-300 ppi, Letter size scan (should be >1MB)</small>
  </div>

  <div class="form-group">
    <label>
      <input type="checkbox" id="consent" name="consent" value="true" required>
      I agree to grant the school marketing rights to print, publicly display, and use my artwork for creative purposes.
    </label>
  </div>

  <button type="submit" id="submitBtn">Upload</button>
  <div class="loading" id="loading" style="display:none;">
    <span></span><span></span><span></span>
  </div>
</form>

<div class="success" id="successMsg" style="display:none;">Upload successful!</div>
<div class="error" id="errorMsg" style="display:none;"></div>

<h2>Gallery</h2>
<div class="gallery" id="gallery"></div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyS8EeAEoACk6HqauFS1y44kI7j20xmuTmIJPucYmtnCBBBSiQu_uSZ8vJGftIaHueFvA/exec"; // 這裡換成 Google Apps Script 部署的 /exec URL

// 載入徵件數量
async function loadCount(){
  try {
    const res = await fetch(`${SCRIPT_URL}?action=count`);
    const data = await res.json();
    document.querySelector('.count').textContent = `Total drawings collected: ${data.count || 0}`;
  } catch(e) {
    document.querySelector('.count').textContent = `Unable to load count`;
  }
}

// 載入圖庫
async function loadGallery(){
  try {
    const res = await fetch(`${SCRIPT_URL}?action=gallery`);
    const data = await res.json();
    const gallery = document.getElementById('gallery');
    gallery.innerHTML = '';
    if(data.items && data.items.length){
      data.items.forEach(item => {
        const img = document.createElement('img');
        img.src = item.fileUrl;
        img.alt = `${item.title} by ${item.name}`;
        gallery.appendChild(img);
      });
    }
  } catch(e) {
    console.error(e);
  }
}

document.getElementById('uploadForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const fileInput = document.getElementById('file');
  const file = fileInput.files[0];
  const submitBtn = document.getElementById('submitBtn');
  const loading = document.getElementById('loading');
  const successMsg = document.getElementById('successMsg');
  const errorMsg = document.getElementById('errorMsg');

  successMsg.style.display = 'none';
  errorMsg.style.display = 'none';

  // 檔案大小檢查
  if(!file){
    errorMsg.textContent = 'Please select a file.';
    errorMsg.style.display = 'block';
    return;
  }
  if(file.size < 1*1024*1024 || file.size > 3*1024*1024){
    errorMsg.textContent = 'File must be between 1MB and 3MB.';
    errorMsg.style.display = 'block';
    return;
  }

  submitBtn.disabled = true;
  loading.style.display = 'inline-block';

  // 嘗試 multipart/form-data
  let useBase64 = false;
  let formData = new FormData();
  formData.append('name', document.getElementById('name').value);
  formData.append('email', document.getElementById('email').value);
  formData.append('title', document.getElementById('title').value);
  formData.append('consent', document.getElementById('consent').checked ? 'true' : 'false');
  formData.append('file', file, file.name);

  try {
    let res = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
    let data = await res.json();
    if(!data.ok && data.error && data.error.includes('No file uploaded')){
      useBase64 = true;
    } else if(data.ok){
      successMsg.style.display = 'block';
      await loadCount();
      await loadGallery();
    } else {
      throw new Error(data.error || 'Unknown error');
    }
  } catch(e) {
    useBase64 = true;
  }

  // Base64 備援
  if(useBase64){
    const reader = new FileReader();
    reader.onload = async function(){
      const base64Data = reader.result.split(',')[1];
      let fd = new FormData();
      fd.append('name', document.getElementById('name').value);
      fd.append('email', document.getElementById('email').value);
      fd.append('title', document.getElementById('title').value);
      fd.append('consent', document.getElementById('consent').checked ? 'true' : 'false');
      fd.append('filebase64', base64Data);
      fd.append('mimetype', file.type);
      fd.append('filename', file.name);
      try {
        let res2 = await fetch(SCRIPT_URL, { method: 'POST', body: fd });
        let data2 = await res2.json();
        if(data2.ok){
          successMsg.style.display = 'block';
          await loadCount();
          await loadGallery();
        } else {
          throw new Error(data2.error || 'Upload failed');
        }
      } catch(err2) {
        errorMsg.textContent = err2.message;
        errorMsg.style.display = 'block';
      } finally {
        submitBtn.disabled = false;
        loading.style.display = 'none';
      }
    };
    reader.readAsDataURL(file);
  } else {
    submitBtn.disabled = false;
    loading.style.display = 'none';
  }
});

// 初始化
loadCount();
loadGallery();
</script>

</body>
</html>
