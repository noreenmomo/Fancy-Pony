<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fancy Pony — Artwork Submission</title>
<style>
  :root{
    --brand:#2563eb;
    --brand-600:#1d4ed8;
    --ok:#16a34a;
    --warn:#b45309;
    --err:#b91c1c;
    --ink:#0f172a;
    --muted:#6b7280;
    --card-bg: rgba(255,255,255,0.8); /* 80% 透明白 */
  }
  html,body{height:100%}
  body{
    margin:0; font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    color:var(--ink);
    /* 背景小 pony 重複鋪滿 */
    background-image:url('https://i.postimg.cc/jSmGH445/Pony.png');
    background-repeat: repeat;
    background-size: 220px auto;
    background-attachment: fixed;
  }
  .wrap{
    max-width: 900px;
    margin: 32px auto;
    padding: 20px 18px;
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: 0 6px 20px rgba(0,0,0,.08);
  }
  h1{margin:0 0 4px 0; font-size: clamp(22px,4.5vw,36px); letter-spacing:.3px}
  .subtle{color:var(--muted); margin: 6px 0 22px 0; font-weight:600}
  .grid{display:block} /* 一行一個 */
  .field{margin:14px 0}
  label{display:block; font-weight:700; margin-bottom:6px}
  input[type="text"], input[type="email"], textarea{
    width:80%; /* 欄位縮小到 80% */
    max-width:100%;
    padding:12px 12px;
    border:1px solid #d1d5db; border-radius:10px; background:#fff;
    font-size:16px; outline:none;
  }
  textarea{min-height:120px; resize:vertical}
  .muted{color:var(--muted)}
  .note{font-size:14px; color:#475569}

  /* 自訂漂亮的 Choose File 按鈕 */
  .file-row{display:flex; align-items:center; gap:12px}
  .file-wrap{position:relative; display:inline-block}
  .file-wrap input[type="file"]{
    position:absolute; inset:0; opacity:0; cursor:pointer;
  }
  .btn-file{
    display:inline-block; padding:10px 16px; border-radius:12px;
    background:var(--brand); color:#fff; font-weight:800; border:none; cursor:pointer;
    transition:transform .02s ease, filter .12s ease;
  }
  .btn-file:hover{filter:brightness(1.05)}
  .btn-file:active{transform:translateY(1px)}
  .file-name{font-size:14px; color:var(--muted)}

  .agree{display:flex; gap:10px; align-items:flex-start; margin:18px 0}
  .agree input{margin-top:5px}

  .btn{
    display:inline-block; padding:12px 18px; border-radius:14px; border:none;
    background:var(--brand); color:#fff; font-weight:900; cursor:pointer;
    transition:transform .02s ease, filter .12s ease;
  }
  .btn:hover{filter:brightness(1.05)}
  .btn:active{transform:translateY(1px)}
  .btn[disabled]{opacity:.6; cursor:not-allowed}

  .bar{height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; margin-top:12px}
  .bar > i{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--brand), var(--ok)); transition:width .2s ease}

  .status{margin:12px 0 6px 0; font-weight:700}
  .ok{color:var(--ok)}
  .warn{color:var(--warn)}
  .err{color:var(--err)}

  /* List 區塊（純文字） */
  .panel{margin-top:26px; padding:18px; background: var(--card-bg); border-radius:16px}
  .panel h2{margin:0 0 10px 0; font-size:26px}
  .actions{float:right; margin-top:-32px}
  .a{color:var(--brand); text-decoration:none; font-weight:800}
  .a:hover{text-decoration:underline}
  .list{display:flex; flex-direction:column; gap:10px}
  .item{
    padding:12px 12px; border:1px solid #e5e7eb; border-radius:12px; background:#fff;
  }
  .ttl{font-weight:800}
  .sub{font-size:13px; color:var(--muted)}
  .desc{margin-top:4px; white-space:pre-wrap}
  .pair{display:flex; align-items:baseline; gap:8px}

  @media (max-width:640px){
    input[type="text"], input[type="email"], textarea{width:100%}
    .actions{float:none; margin:6px 0 0 0}
  }
</style>
</head>
<body>
  <main class="wrap">
    <h1>Fancy Pony — Artwork Submission</h1>
    <div class="subtle">Total drawings collected: <span id="count">–</span></div>

    <form id="form" class="grid" novalidate>
      <div class="field">
        <label for="name">Your Name *</label>
        <input id="name" name="name" type="text" placeholder="e.g., Alex Chen" required>
      </div>

      <div class="field">
        <label for="email">Your Email *</label>
        <input id="email" name="email" type="email" placeholder="you@example.com" required>
      </div>

      <div class="field">
        <label for="title">Pony Name *</label>
        <input id="title" name="title" type="text" placeholder="Your pony's name" required>
      </div>

      <div class="field">
        <label>Upload File *</label>
        <div class="file-row">
          <span class="file-wrap">
            <button class="btn-file" type="button">Choose File</button>
            <input id="file" name="file" type="file" accept=".jpg,.jpeg,.png,.pdf" required>
          </span>
          <span id="fname" class="file-name">no file selected</span>
        </div>
        <div class="note" style="margin-top:8px">
          File size must be between <strong>1&nbsp;MB</strong> and <strong>5&nbsp;MB</strong>.
          Recommended: <strong>150–300&nbsp;ppi</strong> (Letter size scan typically &gt; 1&nbsp;MB).
        </div>
      </div>

      <div class="field">
        <label for="description">Description (optional)</label>
        <textarea id="description" name="description" placeholder="Tell us about your pony…"></textarea>
      </div>

      <div class="agree">
        <input id="consent" name="consent" type="checkbox" value="true" required>
        <label for="consent" style="font-weight:600">
          I agree to grant the school marketing rights to print, publicly display, and use my artwork for creative purposes.
        </label>
      </div>

      <div class="pair">
        <button id="submitBtn" class="btn" type="submit">Upload</button>
        <div id="status" class="status"></div>
      </div>
      <div class="bar"><i id="bar"></i></div>
      <div id="pct" class="sub" style="margin-top:4px">0%</div>
    </form>

    <section class="panel">
      <h2 style="display:inline">Recent submissions</h2>
      <div class="actions"><a class="a" href="#" id="refresh">refresh</a></div>
      <div id="list" class="list">
        <div class="item">Loading…</div>
      </div>
    </section>
  </main>

<script>
  // === Replace with your latest Web App /exec URL ===
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzqnplLlJsrf1rgLQmocmeLOTmyub-tj6jNeaMscqG5v7QfxuDZ_sR-D8sjLv3fDPkO_w/exec';

  const $ = id => document.getElementById(id);

  // tiny helpers
  function setBar(n){ $('bar').style.width = Math.max(0, Math.min(100, n)) + '%'; $('pct').textContent = Math.round(n) + '%'; }
  function say(cls, msg){ const el=$('status'); el.className='status '+(cls||''); el.textContent = msg || ''; }
  function timeStr(v){
    try{
      const d = (v instanceof Date) ? v : (v ? new Date(v) : null);
      return d ? d.toLocaleString() : '';
    }catch{ return ''; }
  }

  // show chosen file name
  $('file').addEventListener('change', (e)=>{
    $('fname').textContent = e.target.files[0]?.name || 'no file selected';
  });

  // count
  async function refreshCount(){
    try{
      const r = await fetch(SCRIPT_URL + '?action=count', {cache:'no-store'});
      const j = await r.json();
      $('count').textContent = j.ok ? (j.count ?? 0) : '–';
    }catch{ $('count').textContent = '–'; }
  }

  // list (text only)
  async function loadRecent(){
    const box = $('list');
    box.innerHTML = '<div class="item">Loading…</div>';
    try{
      const r = await fetch(SCRIPT_URL + '?action=recent&limit=12', {cache:'no-store'});
      if (!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();
      if (!j.ok) throw new Error(j.error || 'API error');

      const items = j.items || [];
      if (!items.length){ box.innerHTML = '<div class="item">No items yet.</div>'; return; }

      box.innerHTML = '';
      for (const it of items){
        const title = (it.title || 'Untitled');
        const name  = (it.name  || 'Anonymous');
        const ts    = timeStr(it.timestamp);
        const desc  = (it.description || '').trim();
        const url   = (it.fileUrl || '').trim();

        const row = document.createElement('div');
        row.className = 'item';
        row.innerHTML = `
          <div class="ttl">${title}</div>
          <div class="sub">${ts}${name ? ' • '+name : ''}</div>
          ${desc ? `<div class="desc">${desc}</div>` : ''}
          ${url ? `<div style="margin-top:6px"><a class="a" target="_blank" rel="noopener" href="${url}">Open file</a></div>` : ''}
        `;
        box.appendChild(row);
      }
    }catch(err){
      box.innerHTML = `<div class="item">Failed to load. <span class="sub">${err.message || err}</span></div>`;
    }
  }
  $('refresh').addEventListener('click', (e)=>{ e.preventDefault(); loadRecent(); });

  // upload with multipart first, fallback to base64 on CORS/network error
  async function fileToBase64(file){
    return new Promise((res, rej)=>{
      const fr = new FileReader();
      fr.onload = () => {
        const s = String(fr.result || '');
        const i = s.indexOf('base64,');
        res(i>=0 ? s.slice(i+7) : s);
      };
      fr.onerror = () => rej(fr.error || new Error('File read error'));
      fr.readAsDataURL(file);
    });
  }

  $('form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const btn = $('submitBtn');
    const file = $('file').files[0];
    setBar(0); say('', '');

    // simple client checks
    if (!file){ say('err','Please choose a file.'); return; }
    const sizeMB = file.size / (1024*1024);
    if (sizeMB < 1 || sizeMB > 5){
      say('err','File must be between 1 MB and 5 MB.'); return;
    }
    if (!$('consent').checked){
      say('err','Please agree to the consent.'); return;
    }

    btn.disabled = true;
    say('warn','Uploading…'); setBar(5);

    // 1) try multipart (simple request: no custom headers)
    try{
      const fd = new FormData();
      fd.append('name', $('name').value.trim());
      fd.append('email', $('email').value.trim());
      fd.append('title', $('title').value.trim());
      fd.append('description', $('description').value.trim());
      fd.append('consent', $('consent').checked ? 'true' : 'false');
      fd.append('file', file, file.name); // 必須叫 file

      const r = await fetch(SCRIPT_URL, { method:'POST', body: fd });
      setBar(70);
      if (!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();

      if (j.ok){
        setBar(100); say('ok','Upload successful.');
        $('form').reset(); $('fname').textContent='no file selected'; setTimeout(()=>setBar(0), 800);
        refreshCount(); loadRecent();
        btn.disabled = false; return;
      }
      // 如果後端回 ok:false，丟出錯誤讓 fallback 有機會跑
      throw new Error(j.error || 'Server refused');
    }catch(err){
      // 2) fallback: base64（部分環境跨網域 preflight 失敗時使用）
      say('warn','Network is blocking cross-origin upload. Using safe fallback…'); setBar(30);
      try{
        const b64 = await fileToBase64(file);
        const fd2 = new FormData();
        fd2.append('name', $('name').value.trim());
        fd2.append('email', $('email').value.trim());
        fd2.append('title', $('title').value.trim());
        fd2.append('description', $('description').value.trim());
        fd2.append('consent', $('consent').checked ? 'true' : 'false');
        fd2.append('filebase64', b64);
        fd2.append('mimetype', file.type || 'application/octet-stream');
        fd2.append('filename', file.name || 'upload.bin');

        const r2 = await fetch(SCRIPT_URL, { method:'POST', body: fd2 });
        setBar(85);
        if (!r2.ok) throw new Error('HTTP '+r2.status);
        const j2 = await r2.json();

        if (j2.ok){
          setBar(100); say('ok','Upload sent. Waiting for confirmation…');
          $('form').reset(); $('fname').textContent='no file selected'; setTimeout(()=>setBar(0), 800);
          refreshCount(); loadRecent();
        }else{
          say('err','Upload failed: ' + (j2.error || 'Unknown error'));
        }
      }catch(err2){
        say('err','Upload failed: ' + (err2.message || err2));
      }finally{
        btn.disabled = false;
      }
      return;
    }
  });

  // init
  refreshCount();
  loadRecent();
</script>
</body>
</html>
