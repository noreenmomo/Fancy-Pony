<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fancy Pony – Art Submission</title>
<style>
  :root { --green:#22c55e; --green-h:#16a34a; }
  body { font-family: Arial, sans-serif; margin: 2rem; background:#fafafa; color:#111; }
  h1 { color:#333; margin-top:0; }
  form { background:#fff; padding:1rem; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.08); }
  label { display:block; margin-top:.6rem; font-weight:600; }
  input[type="text"], input[type="email"], input[type="file"], textarea {
    width:100%; padding:.6rem .7rem; margin-top:.35rem; border:1px solid #d1d5db; border-radius:8px; box-sizing:border-box;
  }
  textarea { resize:vertical; min-height:110px; }
  input[type="checkbox"] { width:auto; margin-right:.5rem; vertical-align:middle; }
  button { margin-top:1rem; padding:.65rem 1.1rem; background:var(--green); color:#fff; border:0; border-radius:10px; cursor:pointer; font-weight:700; }
  button:hover { background:var(--green-h); }
  #status { margin-top:1rem; }
  .card { padding:.8rem 1rem; border:1px solid #e5e7eb; border-radius:10px; background:#f8fff4; display:inline-block; }
  .error { background:#fff1f2; border-color:#fecdd3; }
  .highlight { background:#ffec99; transition:background-color 1s ease; }
  .muted { color:#6b7280; font-size:.9rem; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
</style>
</head>
<body>
  <h1>Fancy Pony – Art Submission</h1>
  <p>Please fill in the form below to submit your artwork. If you provide your email, we will send a confirmation message.</p>

  <form id="uploadForm" novalidate>
    <label for="name">Your Name</label>
    <input id="name" name="name" type="text" required />

    <label for="class">Class</label>
    <input id="class" name="class" type="text" required />

    <label for="title">Artwork Title</label>
    <input id="title" name="title" type="text" />

    <label for="description">Description</label>
    <textarea id="description" name="description"></textarea>

    <label for="email">Email (for confirmation)</label>
    <input id="email" name="email" type="email" />

    <label for="file">Choose File (JPG / PNG / PDF) – Please scan at 150–300 ppi</label>
    <input id="file" name="file" type="file" accept=".jpg,.jpeg,.png,.pdf" required />

    <label>
      <input id="consent" name="consent" type="checkbox" value="true" required />
      I confirm that I have the rights to submit this work.
    </label>

    <button type="submit">Submit</button>
  </form>

  <div id="status" class="muted"></div>

  <div style="margin-top:1rem;">
    <strong>Total submissions:</strong> <span id="count">Loading...</span>
    <span id="ver" class="muted mono" style="margin-left:.5rem;"></span>
  </div>

<script>
  // ===== SET THIS to your exact Web App /exec URL =====
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxsLbUN-3aqmAWSyuxAkmsmUvi77DfE8lQgkIKSJzGEdR4MkSpH3JL1OrAgyZ4aM_M_/exec'.trim();

  const $ = id => document.getElementById(id);

  // File → base64 (strip "data:*;base64," prefix)
  function fileToBase64(file){
    return new Promise((resolve, reject)=>{
      const fr = new FileReader();
      fr.onload = () => {
        const s = String(fr.result || '');
        const i = s.indexOf('base64,');
        resolve(i >= 0 ? s.slice(i + 7) : s);
      };
      fr.onerror = () => reject(fr.error || new Error('File read error'));
      fr.readAsDataURL(file);
    });
  }

  async function refreshCount(){
    const el = $('count'), v = $('ver');
    try{
      const r = await fetch(SCRIPT_URL + '?action=count', { cache: 'no-store' });
      const txt = await r.text();
      // console.log('count raw =>', txt);
      const j = JSON.parse(txt);
      if (j.ok) {
        el.textContent = j.count ?? 0;
        v.textContent = j.version ? `(${j.version}${j.marker ? ' ' + j.marker : ''})` : '';
        el.classList.add('highlight');
        setTimeout(()=>el.classList.remove('highlight'), 900);
      } else {
        el.textContent = 'Error';
        v.textContent = j.error ? `(err: ${j.error})` : '';
      }
    }catch(e){
      el.textContent = 'Error';
      v.textContent = `(fetch failed)`;
      console.error('count fetch failed =>', e);
    }
  }

  $('uploadForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const status = $('status');
    status.textContent = 'Preparing upload…';

    const file = $('file').files[0];
    if (!file){ status.innerHTML = '<span class="card error">Please choose a file.</span>'; return; }

    try{
      // Build payload
      const fd = new FormData();
      fd.append('name', $('name').value.trim());
      fd.append('class', $('class').value.trim());
      fd.append('title', $('title').value.trim());
      fd.append('description', $('description').value.trim());
      fd.append('email', $('email').value.trim());
      fd.append('consent', $('consent').checked ? 'true' : 'false');

      const b64 = await fileToBase64(file);
      fd.append('filebase64', b64);
      fd.append('mimetype', file.type || 'application/octet-stream');
      fd.append('filename', file.name || 'upload.bin');

      status.textContent = 'Uploading…';
      const r = await fetch(SCRIPT_URL, { method:'POST', body: fd });
      const txt = await r.text();
      const data = JSON.parse(txt);
      console.log('server response:', data);

      if (data.ok){
        const line = data.emailSent
          ? 'You have successfully uploaded. A confirmation email has been sent.'
          : 'You have successfully uploaded.' + (data.emailError ? ` (Email could not be sent: ${data.emailError})` : '');
        status.innerHTML =
          `<div class="card">${line}</div>
           <div style="margin-top:.4rem;">File link:
             <a target="_blank" rel="noopener" href="${data.fileUrl}">Open</a></div>`;
        e.target.reset();
        await refreshCount();
      } else {
        status.innerHTML = `<div class="card error">Upload failed: ${data.error || 'Unknown error'}</div>`;
      }
    }catch(err){
      status.innerHTML = `<div class="card error">Error: ${err.message}</div>`;
      console.error(err);
    }
  });

  // initial
  refreshCount();
</script>
</body>
</html>
