<!doctype html>
<meta charset="utf-8" />
<title>Fancy Pony — Safe Uploader</title>
<style>
  body { font-family: Arial, sans-serif; margin: 2rem; }
  label { display:block; margin:.6rem 0 .25rem; }
  input, button { font-size: 14px; }
  #status { margin-top: .75rem; white-space: pre-wrap; }
</style>

<h1>Fancy Pony — Safe Uploader</h1>

<form id="f" onsubmit="return false;">
  <label>Your name</label>
  <input id="name" type="text" required>

  <label>Choose file (JPG/PNG/PDF)</label>
  <input id="file" type="file" accept=".jpg,.jpeg,.png,.pdf" required>

  <div style="margin-top:.8rem">
    <button id="btn">Upload</button>
  </div>
</form>

<div id="status"></div>

<script>
  // 換成你的 Web App /exec
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyS8EeAEoACk6HqauFS1y44kI7j20xmuTmIJPucYmtnCBBBSiQu_uSZ8vJGftIaHueFvA/exec';

  const $ = id => document.getElementById(id);
  $('btn').addEventListener('click', upload);

  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onload = () => {
        const s = String(fr.result || '');
        const i = s.indexOf('base64,');
        resolve(i >= 0 ? s.slice(i + 7) : s);
      };
      fr.onerror = () => reject(fr.error || new Error('read error'));
      fr.readAsDataURL(file);
    });
  }

  async function upload() {
    const status = $('status');
    const file = $('file').files[0];
    if (!file) { status.textContent = 'Please choose a file.'; return; }

    status.textContent = 'Uploading…';

    try {
      // 先走「標準」路徑：multipart/form-data + file 欄位
      const fd = new FormData();
      fd.append('name', $('name').value.trim());
      fd.append('file', file, file.name); // 重點：欄位名一定叫「file」

      // 同時附上 base64 備援（後端也有支援）
      fd.append('filename', file.name);
      fd.append('mimetype', file.type || 'application/octet-stream');
      fd.append('filebase64', await fileToBase64(file));

      const r = await fetch(SCRIPT_URL, { method: 'POST', body: fd });
      const txt = await r.text();
      let data;
      try { data = JSON.parse(txt); } catch { throw new Error('Server returned non-JSON: ' + txt); }

      console.log('server response:', data);
      if (data.ok) {
        status.textContent = `OK\nfileId: ${data.fileId || '(n/a)'}\nfileUrl: ${data.fileUrl || '(n/a)'}\ncount: ${data.count}`;
      } else {
        status.textContent = `Failed: ${data.error}\n` + (data.diag ? JSON.stringify(data.diag, null, 2) : '');
      }
    } catch (err) {
      status.textContent = 'Error: ' + err.message;
      console.error(err);
    }
  }
</script>
