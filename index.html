<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fancy Pony Parade — Artwork Submission</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
  :root{
    --DCES:#2563EB;
    --brand:#43C7C7;
    --ok:#16a34a;
    --warn:#b45309;
    --err:#b91c1c;
    --ink:#0f172a;
    --muted:#3A3A3A;
    --card-bg: rgba(255,255,255,0.92);
  }

  /* base */
  html,body{height:100%}
  body{
    margin:0;
    font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    color:var(--ink);
    background-image:url('https://i.postimg.cc/jSmGH445/Pony.png');
    background-repeat:repeat;
    background-size:220px auto;
    background-attachment:fixed;
  }
  p{ font-size:.8em; line-height:1.4; }

  /* intro */
  .intro{
    max-width:42rem;
    margin:0 auto 1.25rem auto;
    text-align:center;
    font-size:clamp(12px,2.2vw,14px);
    line-height:1.55;
  }
  .highlight-text{ display:inline-block; font-weight:800; color:#08b3b3; }
  .highlight-text1{ color:var(--muted); font-size:1.2em; font-weight:600; }

  /* footer credit */
  .bg-credit{
    position:fixed; bottom:8px; left:50%; transform:translateX(-50%);
    font-size:12px; color:#444; background:rgba(255,255,255,0.55);
    padding:3px 8px; border-radius:6px; pointer-events:none; white-space:nowrap;
  }

  /* frame */
  .wrap{
    max-width:900px; margin:32px auto; padding:20px 18px;
    background:var(--card-bg); border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,.08);
  }

  /* header */
  .logo{ display:block; margin:0 auto 10px; width:clamp(200px,80%,300px); height:auto; }
  h1{ margin:0 0 8px 0; text-align:center; letter-spacing:.3px; }
  h1 .title-main-DCES{ display:block; font-size:clamp(.4em,5vw,0.6em); font-weight:900; color:var(--DCES); }
  h1 .title-main{ display:block; font-size:clamp(1.2em,5vw,1.4em); font-weight:900; }
  h1 .title-sub{ display:block; font-size:clamp(0.8em,3vw,1em); font-weight:600; color:var(--muted); }

  /* form */
  .grid{display:block}
  .field{margin:14px 0}
  label{display:block; font-weight:700; margin-bottom:6px}
  input[type="text"], input[type="email"], textarea{
    width:100%; box-sizing:border-box; padding:12px 14px; margin:8px 0;
    border:1px solid #e5e7eb; border-radius:12px; background:#fff; font-size:1rem;
  }
  textarea{min-height:80px; resize:vertical}

  /* file input */
  .file-row{display:flex; align-items:center; gap:12px}
  .file-wrap{position:relative; display:inline-block}
  .file-wrap input[type="file"]{position:absolute; inset:0; opacity:0; cursor:pointer}
  .btn-file{
    display:inline-block; padding:10px 16px; border-radius:12px;
    background:var(--brand); color:#fff; font-weight:800; border:none; cursor:pointer;
    transition:filter .12s ease, transform .02s ease; font-size:1.1em;
  }
  .btn-file:hover{filter:brightness(1.05)}
  .btn-file:active{transform:translateY(1px)}
  .file-name{font-size:14px; color:var(--muted)}

  .agree{display:flex; gap:10px; align-items:flex-start; margin:18px 0}
  .agree input{margin-top:3px}
  input[type="checkbox"]{ transform:scale(1.35); margin-right:6px }

  /* buttons */
  .btn{
    display:inline-block; padding:12px 18px; border-radius:14px; border:none;
    background:var(--brand); color:#fff; font-weight:900; cursor:pointer;
    transition:filter .12s ease, transform .02s ease; font-size:1.1em;
  }
  .btn:hover{filter:brightness(1.05)}
  .btn:active{transform:translateY(1px)}
  .btn[disabled]{opacity:.6; cursor:not-allowed}

  /* status & progress */
  .status{margin:12px 0 6px 0; font-weight:700}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  .sub{color:var(--muted); font-weight:600}
  .bar{height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; margin-top:10px}
  .bar>i{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--brand),var(--ok)); transition:width .2s ease}

  /* recent panel */
  .panel{margin-top:26px; padding:18px; background:var(--card-bg); border-radius:16px}
  .panel-header{display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:10px}
  .panel-header h2{margin:0; font-size:26px}
  .panel-info{color:var(--muted); font-weight:600}
  .actions{display:flex; gap:12px; align-items:center}
  .a{color:var(--brand); text-decoration:none; font-weight:800}
  .a:hover{text-decoration:underline}

  /* list with arrows */
  .list-wrap{ position:relative; padding:0 50px; }
  .list{display:flex; flex-direction:column; gap:10px; min-height:170px}
  .item{padding:12px; border:1px solid #e5e7eb; border-radius:12px; background:#fff}
  .ttl{font-weight:800}
  .desc{margin-top:4px; white-space:pre-wrap}
  .subline{font-size:13px; color:var(--muted)}

  .nav-arrow{
    position:absolute; top:50%; transform:translateY(-50%);
    width:40px; height:40px; display:flex; align-items:center; justify-content:center;
    border:none; border-radius:999px; background:#fff; color:var(--brand);
    font-weight:900; font-size:36px; box-shadow:0 4px 12px rgba(0,0,0,.12);
    cursor:pointer; z-index:2;
  }
  .nav-arrow:disabled{opacity:.45; cursor:not-allowed}
  .nav-arrow.left{ left:8px; }
  .nav-arrow.right{ right:8px; }

  @media (max-width:640px){
    .list-wrap{ padding:0 52px; }
    .nav-arrow{ width:40px; height:40px; font-size:30px; }
    .nav-arrow.left{ left:8px; }
    .nav-arrow.right{ right:8px; }
  }

  .pager{ display:none !important; }

  /* poster */
  .poster{ text-align:center; margin-top:20px; }
  .poster img{ max-width:100%; height:auto; border-radius:8px; }
</style>
</head>
<body>

  <main class="wrap">
    <!-- MAINTAIN: Header -->
    <img class="logo" src="https://i.postimg.cc/xdB0mqvM/The-unicorn-in-the-sky.png" alt="DCES unicorn logo" />
    <h1>
      <span class="title-main"><span class="title-main-DCES">DCES</span>Fancy Pony Parade</span>
      <span class="title-sub">Artwork Submission</span>
    </h1>

    <!-- MAINTAIN: Intro -->
    <p class="intro">
      Saddle Up for Creativity Where Ponies Meet Imagination!<br>
      This Lunar New Year, create your very own Fancy Pony! <br>
      Families and young artists are invited to<br>
      design a colorful, letter-sized pony drawing<br>
      bursting with festive spirit!<br>
      <span class="highlight-text1">The Magic in 3 Steps:</span><br>
      <span class="highlight-text1">Create. Celebrate. Capture.</span><br>
      Submit your pony artwork,<br>
      see it feature on our paper bags,<br>
      and showcase it on the Pony Parade Wall. <br>
      Don’t forget your photo finish!<br>
      Let’s fill the celebration with<br>
      color, creativity, and joy.<br>
      <span class="highlight-text">Submit your Fancy Pony today</span><br>
      <span class="highlight-text">and join the parade!</span>
    </p>

    <!-- MAINTAIN: Form -->
    <form id="form" class="grid" novalidate>
      <div class="field">
        <label for="name">Your Name *</label>
        <input id="name" name="name" type="text" placeholder="e.g., Demi Tai" required>
      </div>

      <div class="field">
        <label for="email">Your Email *</label>
        <input id="email" name="email" type="email" placeholder="you@example.com" required>
      </div>

      <div class="field">
        <label for="title">Pony Name *</label>
        <input id="title" name="title" type="text" placeholder="Your pony's name" required>
      </div>

      <!-- MAINTAIN: File Upload (images only) -->
      <div class="field">
        <label>Upload File *</label>
        <div class="file-row">
          <span class="file-wrap">
            <button class="btn-file" type="button">Choose File</button>
            <input id="file" name="file" type="file"
                   accept="image/jpeg,image/png" required>
          </span>
          <span id="fname" class="file-name">No file selected</span>
        </div>

        <!-- Live file info -->
        <div id="fileInfo" class="sub" style="margin-top:6px;"></div>

        <!-- Guidance text (images only) -->
        <div class="sub" style="margin-top:6px">
          JPG or PNG only. File size must be between <strong>1&nbsp;MB</strong> and <strong>5&nbsp;MB</strong>.
          Recommended scan: <strong>150–300&nbsp;ppi</strong> (Letter size scan typically &gt; 1&nbsp;MB).
        </div>
      </div>

      <div class="field">
        <label for="description">Description (optional)</label>
        <textarea id="description" name="description" placeholder="Tell us about your pony…"></textarea>
      </div>

      <div class="agree">
        <input id="consent" name="consent" type="checkbox" value="true" required>
        <label for="consent" style="font-weight:600">
          I grant the school permission to print, display, and use my artwork for promotional and educational purposes.
        </label>
      </div>

      <div style="display:flex; align-items:baseline; gap:10px">
        <button id="submitBtn" class="btn" type="submit">Upload</button>
        <div id="status" class="status"></div>
      </div>
      <div class="bar"><i id="bar"></i></div>
      <div id="pct" class="sub" style="margin-top:4px">0%</div>
    </form>

    <!-- MAINTAIN: Recent Submissions -->
    <section class="panel">
      <div class="panel-header">
        <h2>Recent submissions</h2>
        <div class="actions">
          <span class="panel-info">Total drawings collected: <span id="count">–</span></span>
          <a class="a" href="#" id="Refresh" title="Refresh"><i class="fas fa-rotate-right"></i></a>
        </div>
      </div>

      <div class="list-wrap">
        <button class="nav-arrow left"  id="prevBtn" aria-label="Previous page">&lsaquo;</button>
        <div class="list" id="list">
          <div class="item">Loading…</div>
        </div>
        <button class="nav-arrow right" id="nextBtn" aria-label="Next page">&rsaquo;</button>
      </div>
    </section>

    <!-- MAINTAIN: Poster -->
    <div class="poster">
      <h2>
        <span class="title-main">CNY Fancy Pony Parade Station</span><br>
        <span class="title-sub">Step-by-Step Guide</span>
      </h2>
      <img src="https://i.postimg.cc/V6fKhGRR/CNY-Fancy-Pony-Station-Step-by-Step-Guide.png" alt="CNY Fancy Pony Station – Step-by-Step Guide">
    </div>
  </main>

  <div class="bg-credit">Illustration design by Demi Tai</div>

<script>
  /* ===== CONFIG ===== */
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzqnplLlJsrf1rgLQmocmeLOTmyub-tj6jNeaMscqG5v7QfxuDZ_sR-D8sjLv3fDPkO_w/exec';
  const MIN_MB = 1;
  const MAX_MB = 5;
  const ALLOWED_MIME = new Set(['image/jpeg','image/png']);

  /* ===== Helpers ===== */
  const $ = id => document.getElementById(id);
  const S = v => v == null ? '' : String(v);
  function setBar(n){ $('bar').style.width = Math.max(0, Math.min(100, n)) + '%'; $('pct').textContent = Math.round(n) + '%'; }
  function say(cls, msg){ const el=$('status'); el.className='status ' + (cls||''); el.textContent = msg || ''; }
  function timeStr(v){ try{ const d = v instanceof Date ? v : new Date(v); return isNaN(d.getTime()) ? '' : d.toLocaleString(); }catch{ return ''; } }
  function fmtMB(bytes){ return (bytes / (1024*1024)).toFixed(2); }

  /* ===== File UI ===== */
  document.querySelector('.btn-file').addEventListener('click', ()=> $('file').click());

  $('file').addEventListener('change', e => {
    const f = e.target.files[0];
    if (!f){ $('fname').textContent = 'No file selected'; $('fileInfo').textContent = ''; return; }

    $('fname').textContent = f.name;
    const mb = Number(fmtMB(f.size));
    const typeOk = ALLOWED_MIME.has(f.type);
    const sizeOk = (mb >= MIN_MB && mb <= MAX_MB);

    const info = `Selected: ${f.name} (${mb} MB)`;
    const el = $('fileInfo');
    if (typeOk && sizeOk){
      el.textContent = info + ' — OK';
      el.style.color = '#16a34a';
    }else{
      const why = [
        typeOk ? '' : 'type must be JPG or PNG',
        sizeOk ? '' : `size must be ${MIN_MB}–${MAX_MB} MB`
      ].filter(Boolean).join('; ');
      el.textContent = info + ' — ' + why;
      el.style.color = '#b91c1c';
    }
  });

  /* ===== Recent count/list ===== */
  async function refreshCount(){
    try{
      const r = await fetch(SCRIPT_URL + '?action=count', {cache:'no-store'});
      const j = await r.json();
      $('count').textContent = j.ok ? (j.count ?? 0) : '–';
    }catch{ $('count').textContent = '–'; }
  }
  $('Refresh').addEventListener('click', (e)=>{ e.preventDefault(); refreshCount(); loadRecent(); });

  const pageSize = 3;
  let itemsAll = [];
  let pageIndex = 0;

  function renderPage(){
    const list = $('list');
    if (!itemsAll.length){
      list.innerHTML = '<div class="item">No items yet.</div>';
      $('prevBtn').disabled = true;
      $('nextBtn').disabled = true;
      return;
    }
    const totalPages = Math.max(1, Math.ceil(itemsAll.length / pageSize));
    pageIndex = Math.max(0, Math.min(pageIndex, totalPages-1));

    const start = pageIndex * pageSize;
    const end = start + pageSize;
    const pageItems = itemsAll.slice(start, end);

    list.innerHTML = '';
    for (const it of pageItems){
      const title = S(it.title).trim() || 'Untitled';
      const name  = S(it.name).trim()  || 'Anonymous';
      const desc  = S(it.description).trim();
      const url   = S(it.fileUrl).trim();
      const ts    = timeStr(it.timestamp);

      const row = document.createElement('div');
      row.className = 'item';
      row.innerHTML = `
        <div class="ttl">
          ${url ? `<a class="a" target="_blank" rel="noopener" href="${url}">${title}</a>` : title}
        </div>
        <div class="subline">${[ts, name].filter(Boolean).join(' • ')}</div>
        ${desc ? `<div class="desc">${desc}</div>` : ''}
      `;
      list.appendChild(row);
    }

    $('prevBtn').disabled = (pageIndex === 0);
    $('nextBtn').disabled = (pageIndex >= totalPages-1);
  }

  async function loadRecent(){
    const list = $('list');
    list.innerHTML = '<div class="item">Loading…</div>';
    try{
      const r = await fetch(SCRIPT_URL + '?action=recent&limit=50', { cache:'no-store' });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const j = await r.json();
      if (!j.ok) throw new Error(j.error || 'API error');

      itemsAll = Array.isArray(j.items) ? j.items : [];
      pageIndex = 0;
      renderPage();
    }catch(err){
      list.innerHTML = `<div class="item">Failed to load. <span class="subline">${(err && err.message) || err}</span></div>`;
      $('prevBtn').disabled = true;
      $('nextBtn').disabled = true;
    }
  }

  $('prevBtn').addEventListener('click', ()=>{ pageIndex = Math.max(0, pageIndex-1); renderPage(); });
  $('nextBtn').addEventListener('click', ()=>{ pageIndex = pageIndex+1; renderPage(); });

  // touch swipe
  (() => {
    let startX = 0, dx = 0;
    const area = $('list');
    area.addEventListener('touchstart', e => { startX = e.touches[0].clientX; dx = 0; }, {passive:true});
    area.addEventListener('touchmove',  e => { dx = e.touches[0].clientX - startX; }, {passive:true});
    area.addEventListener('touchend',   () => {
      const threshold = 40;
      if (dx > threshold){ $('prevBtn').click(); }
      else if (dx < -threshold){ $('nextBtn').click(); }
    }, {passive:true});
  })();

  /* ===== Upload (multipart + base64 fallback) ===== */
  function fileToBase64(file){
    return new Promise((res, rej)=>{
      const fr = new FileReader();
      fr.onload = () => {
        const s = String(fr.result || '');
        const i = s.indexOf('base64,');
        res(i>=0 ? s.slice(i+7) : s);
      };
      fr.onerror = () => rej(fr.error || new Error('File read error'));
      fr.readAsDataURL(file);
    });
  }

  $('form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const btn = $('submitBtn');
    const file = $('file').files[0];

    setBar(0); say('', '');

    if (!file){ say('err','Please choose a file.'); return; }

    const mb = file.size / (1024*1024);
    const typeOk = ALLOWED_MIME.has(file.type);
    const sizeOk = (mb >= MIN_MB && mb <= MAX_MB);

    if (!typeOk){ say('err','Only JPG or PNG files are accepted.'); return; }
    if (!sizeOk){ say('err', `File must be between ${MIN_MB} and ${MAX_MB} MB.`); return; }
    if (!$('consent').checked){ say('err','Please agree to the consent.'); return; }

    btn.disabled = true;
    say('warn','Uploading…'); setBar(5);

    try{
      const fd = new FormData();
      fd.append('name', $('name').value.trim());
      fd.append('email', $('email').value.trim());
      fd.append('title', $('title').value.trim());
      fd.append('description', $('description').value.trim());
      fd.append('consent', $('consent').checked ? 'true' : 'false');
      fd.append('file', file, file.name);

      const r = await fetch(SCRIPT_URL, { method:'POST', body: fd });
      setBar(70);
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const j = await r.json();

      if (j.ok){
        setBar(100); say('ok','Upload successful.');
        $('form').reset();
        $('fname').textContent = 'No file selected';
        $('fileInfo').textContent = '';
        setTimeout(()=>setBar(0), 900);
        refreshCount(); loadRecent();
        btn.disabled = false;
        return;
      }
      throw new Error(j.error || 'Server refused');
    }catch(err){
      // fallback
      say('warn','Network is blocking cross-origin upload. Using safe fallback…'); setBar(30);
      try{
        const b64 = await fileToBase64(file);
        const fd2 = new FormData();
        fd2.append('name', $('name').value.trim());
        fd2.append('email', $('email').value.trim());
        fd2.append('title', $('title').value.trim());
        fd2.append('description', $('description').value.trim());
        fd2.append('consent', $('consent').checked ? 'true' : 'false');
        fd2.append('filebase64', b64);
        fd2.append('mimetype', file.type || 'application/octet-stream');
        fd2.append('filename', file.name || 'upload.bin');

        const r2 = await fetch(SCRIPT_URL, { method:'POST', body: fd2 });
        setBar(85);
        if (!r2.ok) throw new Error('HTTP ' + r2.status);
        const j2 = await r2.json();

        if (j2.ok){
          setBar(100); say('ok','Upload sent. Waiting for confirmation.');
          $('form').reset();
          $('fname').textContent = 'No file selected';
          $('fileInfo').textContent = '';
          setTimeout(()=>setBar(0), 900);
          refreshCount(); loadRecent();
        }else{
          say('err','Upload failed: ' + (j2.error || 'Unknown error'));
        }
      }catch(err2){
        say('err','Upload failed: ' + (err2.message || err2));
      }finally{
        btn.disabled = false;
      }
    }
  });

  /* Init */
  refreshCount();
  loadRecent();
</script>
</body>
</html>
