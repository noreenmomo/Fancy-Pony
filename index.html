<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fancy Pony — Artwork Submission</title>
<style>
  :root{
    /* Tweak these two to change button/link colors */
    --brand:#2563eb;          /* buttons + links */
    --brand-600:#1d4ed8;

    --ok:#16a34a;
    --warn:#b45309;
    --err:#b91c1c;
    --ink:#0f172a;
    --muted:#6b7280;
    --card-bg: rgba(255,255,255,0.92);
  }

  html,body{height:100%}
  body{
    margin:0; font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    color:var(--ink);
    background-image:url('https://i.postimg.cc/jSmGH445/Pony.png');
    background-repeat:repeat;
    background-size:220px auto;
    background-attachment:fixed;
  }

  /* background credit — one line, centered bottom */
  .bg-credit{
    position:fixed; bottom:8px; left:50%; transform:translateX(-50%);
    font-size:12px; color:#444; background:rgba(255,255,255,0.55);
    padding:3px 8px; border-radius:6px; pointer-events:none; white-space:nowrap;
  }

  .wrap{
    max-width:900px; margin:32px auto; padding:20px 18px;
    background:var(--card-bg); border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,.08);
  }

  /* header */
  .logo{display:block; margin:0 auto 10px auto; width:128px; max-width:34vw; height:auto}
  h1{margin:0 0 8px 0; font-size:clamp(22px,4.5vw,36px); letter-spacing:.3px; text-align:center}
  .intro{
    text-align:center; max-width:800px; margin:0 auto 20px auto;
    font-size:1.05em; line-height:1.55;
  }

  /* form */
  .grid{display:block}
  .field{margin:14px 0}
  label{display:block; font-weight:700; margin-bottom:6px}
  input[type="text"], input[type="email"], textarea{
    width:100%; box-sizing:border-box; padding:12px 14px; margin:8px 0;
    border:1px solid #e5e7eb; border-radius:12px; background:#fff; font-size:1rem;
  }
  textarea{min-height:80px; resize:vertical}

  /* prettier choose-file */
  .file-row{display:flex; align-items:center; gap:12px}
  .file-wrap{position:relative; display:inline-block}
  .file-wrap input[type="file"]{position:absolute; inset:0; opacity:0; cursor:pointer}
  .btn-file{
    display:inline-block; padding:10px 16px; border-radius:12px;
    background:var(--brand); color:#fff; font-weight:800; border:none; cursor:pointer;
    transition:filter .12s ease, transform .02s ease;
  }
  .btn-file:hover{filter:brightness(1.05)}
  .btn-file:active{transform:translateY(1px)}
  .file-name{font-size:14px; color:var(--muted)}

  .agree{display:flex; gap:10px; align-items:flex-start; margin:18px 0}
  .agree input{margin-top:3px}
  /* bigger checkbox */
  input[type="checkbox"]{ transform:scale(1.35); margin-right:6px }

  .btn{
    display:inline-block; padding:12px 18px; border-radius:14px; border:none;
    background:var(--brand); color:#fff; font-weight:900; cursor:pointer;
    transition:filter .12s ease, transform .02s ease;
  }
  .btn:hover{filter:brightness(1.05)}
  .btn:active{transform:translateY(1px)}
  .btn[disabled]{opacity:.6; cursor:not-allowed}

  .status{margin:12px 0 6px 0; font-weight:700}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  .sub{color:var(--muted); font-weight:600}

  .bar{height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; margin-top:10px}
  .bar > i{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--brand),var(--ok)); transition:width .2s ease}

  /* Recent submissions (now with outside nav buttons) */
  .panel{margin-top:26px; padding:18px; background:var(--card-bg); border-radius:16px}
  .panel-header{display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:10px}
  .panel-header h2{margin:0; font-size:26px}
  .panel-info{color:var(--muted); font-weight:600}
  .actions{display:flex; gap:12px; align-items:center}
  .a{color:var(--brand); text-decoration:none; font-weight:800}
  .a:hover{text-decoration:underline}

  .recent-submissions-container{
    display:flex; align-items:stretch; gap:12px; margin-top:10px;
  }
  .recent-submissions{ flex:1; }
  .list{display:flex; flex-direction:column; gap:10px; min-height: 170px}
  .item{
    padding:12px;
    border:1px solid #e5e7eb; border-radius:12px; background:#fff;
    box-shadow: 0 1px 2px rgba(0,0,0,0.02);
  }
  .ttl{font-weight:800}
  .desc{margin-top:4px; white-space:pre-wrap}
  .subline{font-size:13px; color:var(--muted)}

  .nav-button{
    width:42px; height:42px; border-radius:12px; border:none; cursor:pointer;
    background:#ffffff; box-shadow:0 6px 18px rgba(0,0,0,.08);
    font-size:20px; font-weight:900; color:var(--ink);
    display:flex; align-items:center; justify-content:center;
  }
  .nav-button:disabled{opacity:.45; cursor:not-allowed}
  .page-indicator{margin-top:10px; text-align:center; color:var(--muted); font-weight:700}

  /* Poster below list */
  .poster{ text-align:center; margin-top:28px; }
  .poster-title{ margin:0 0 10px 0; line-height:1.1; }
  .poster-title .title-main{ display:block; font-size:clamp(20px,4.2vw,28px); font-weight:900; }
  .poster-title .title-sub{ display:block; font-size:clamp(16px,3.5vw,22px); color:var(--muted); font-weight:800; }
  .poster img{ max-width:100%; height:auto; border-radius:8px; }
</style>
</head>
<body>

  <main class="wrap">
    <!-- centered logo + title -->
    <img class="logo" src="https://i.postimg.cc/bwYsTGKt/The-unicorn-in-the-sky.png" alt="Fancy Pony logo" />
    <h1>Fancy Pony — Artwork Submission</h1>
    <p class="intro">
      Unleash your creativity this Lunar New Year by designing your family’s very own Fancy Pony!
      Kiddos and families are invited to submit colorful letter-sized pony drawings full of imagination and festive spirit.
      Selected designs will be printed onto paper bags, ready for you to decorate at our special station.
      After adding your unique touch, showcase your masterpiece on the “Pony Parade Wall” and snap a photo to remember the moment.
      Let’s fill the celebration with color, fun, and your amazing ideas — submit your artwork today!
    </p>

    <!-- Form -->
    <form id="form" class="grid" novalidate>
      <div class="field">
        <label for="name">Your Name *</label>
        <input id="name" name="name" type="text" placeholder="e.g., Alex Chen" required>
      </div>

      <div class="field">
        <label for="email">Your Email *</label>
        <input id="email" name="email" type="email" placeholder="you@example.com" required>
      </div>

      <div class="field">
        <label for="title">Pony Name *</label>
        <input id="title" name="title" type="text" placeholder="Your pony's name" required>
      </div>

      <div class="field">
        <label>Upload File *</label>
        <div class="file-row">
          <span class="file-wrap">
            <button class="btn-file" type="button">Choose File</button>
            <input id="file" name="file" type="file" accept=".jpg,.jpeg,.png,.pdf" required>
          </span>
          <span id="fname" class="file-name">no file selected</span>
        </div>
        <div class="sub" style="margin-top:8px">
          File size must be between <strong>1&nbsp;MB</strong> and <strong>5&nbsp;MB</strong>.
          Recommended: <strong>150–300&nbsp;ppi</strong> (Letter size scan typically &gt; 1&nbsp;MB).
        </div>
      </div>

      <div class="field">
        <label for="description">Description (optional)</label>
        <textarea id="description" name="description" placeholder="Tell us about your pony…"></textarea>
      </div>

      <div class="agree">
        <input id="consent" name="consent" type="checkbox" value="true" required>
        <label for="consent" style="font-weight:600">
          I agree to grant the school marketing rights to print, publicly display, and use my artwork for creative purposes.
        </label>
      </div>

      <div style="display:flex; align-items:baseline; gap:8px">
        <button id="submitBtn" class="btn" type="submit">Upload</button>
        <div id="status" class="status"></div>
      </div>
      <div class="bar"><i id="bar"></i></div>
      <div id="pct" class="sub" style="margin-top:4px">0%</div>
    </form>

    <!-- Recent submissions -->
    <section class="panel">
      <div class="panel-header">
        <h2>Recent submissions</h2>
        <div class="actions">
          <span class="panel-info">Total drawings collected: <span id="count">–</span></span>
          <a class="a" href="#" id="refresh">refresh</a>
        </div>
      </div>

      <div class="recent-submissions-container">
        <button class="nav-button" id="prevBtn" aria-label="Previous">‹</button>

        <div class="recent-submissions">
          <div id="list" class="list">
            <div class="item">Loading…</div>
          </div>
        </div>

        <button class="nav-button" id="nextBtn" aria-label="Next">›</button>
      </div>

      <div class="page-indicator" id="pageInd">1 / 1</div>
    </section>

    <!-- Poster below list -->
    <div class="poster">
      <h2 class="poster-title">
        <span class="title-main">CNY Fancy Pony Station</span>
        <span class="title-sub">Step-by-Step Guide</span>
      </h2>
      <img src="https://i.postimg.cc/pXMp7cnz/Summon-Your-Fancy-Pony.png" alt="Pony Station">
    </div>
  </main>

  <!-- background credit -->
  <div class="bg-credit">Illustration design by Demi Tai</div>

<script>
  /* ==== Your Apps Script Web App URL (/exec) ==== */
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzqnplLlJsrf1rgLQmocmeLOTmyub-tj6jNeaMscqG5v7QfxuDZ_sR-D8sjLv3fDPkO_w/exec';

  const $ = id => document.getElementById(id);
  const S = v => v == null ? '' : String(v);

  function setBar(n){ $('bar').style.width = Math.max(0, Math.min(100, n)) + '%'; $('pct').textContent = Math.round(n) + '%'; }
  function say(cls, msg){ const el=$('status'); el.className='status '+(cls||''); el.textContent = msg || ''; }
  function timeStr(v){
    try{ const d = v instanceof Date ? v : new Date(v); return isNaN(d) ? '' : d.toLocaleString(); }
    catch { return ''; }
  }

  $('file').addEventListener('change', e => $('fname').textContent = e.target.files[0]?.name || 'no file selected');

  async function refreshCount(){
    try{
      const r = await fetch(SCRIPT_URL + '?action=count', {cache:'no-store'});
      const j = await r.json(); $('count').textContent = j.ok ? (j.count ?? 0) : '–';
    }catch{ $('count').textContent = '–'; }
  }

  /* ========= Recent list with paging ========= */
  let allItems = [];        // full dataset from server
  const pageSize = 5;       // items per page
  let page = 1;

  function renderPage(){
    const list = $('list');
    if (!allItems.length){
      list.innerHTML = '<div class="item">No items yet.</div>';
      $('pageInd').textContent = '1 / 1';
      $('prevBtn').disabled = $('nextBtn').disabled = true;
      return;
    }
    const totalPages = Math.max(1, Math.ceil(allItems.length / pageSize));
    page = Math.max(1, Math.min(page, totalPages));
    const start = (page - 1) * pageSize;
    const slice = allItems.slice(start, start + pageSize);

    list.innerHTML = '';
    slice.forEach(it => {
      const title = S(it.title).trim() || 'Untitled';
      const name  = S(it.name).trim()  || 'Anonymous';
      const desc  = S(it.description).trim();
      const url   = S(it.fileUrl).trim();
      const ts    = timeStr(it.timestamp);

      const row = document.createElement('div');
      row.className = 'item';
      row.innerHTML = `
        <div class="ttl">${url ? `<a class="a" target="_blank" rel="noopener" href="${url}">${title}</a>` : title}</div>
        <div class="subline">${[ts, name].filter(Boolean).join(' • ')}</div>
        ${desc ? `<div class="desc">${desc}</div>` : ''}
      `;
      list.appendChild(row);
    });

    $('pageInd').textContent = `${page} / ${totalPages}`;
    $('prevBtn').disabled = (page <= 1);
    $('nextBtn').disabled = (page >= totalPages);
  }

  async function loadRecent(){
    const box = $('list');
    box.innerHTML = '<div class="item">Loading…</div>';
    try{
      // get many, we’ll paginate on the client
      const r = await fetch(SCRIPT_URL + '?action=recent&limit=100', { cache:'no-store' });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const j = await r.json();
      if (!j.ok) throw new Error(j.error || 'API error');

      allItems = Array.isArray(j.items) ? j.items : [];
      page = 1;
      renderPage();
    }catch(err){
      box.innerHTML = `<div class="item">Failed to load. <span class="subline">${S(err.message || err)}</span></div>`;
      $('pageInd').textContent = '—';
      $('prevBtn').disabled = $('nextBtn').disabled = true;
    }
  }

  $('prevBtn').addEventListener('click', () => { page--; renderPage(); });
  $('nextBtn').addEventListener('click', () => { page++; renderPage(); });
  $('refresh').addEventListener('click', (e) => { e.preventDefault(); loadRecent(); });

  /* ========= Upload ========= */
  function fileToBase64(file){
    return new Promise((res, rej)=>{
      const fr = new FileReader();
      fr.onload  = () => { const s = String(fr.result||''); const i = s.indexOf('base64,'); res(i>=0?s.slice(i+7):s); };
      fr.onerror = () => rej(fr.error || new Error('File read error'));
      fr.readAsDataURL(file);
    });
  }

  $('form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const btn = $('submitBtn');
    const file = $('file').files[0];
    setBar(0); say('', '');

    if (!file){ say('err','Please choose a file.'); return; }
    const sizeMB = file.size/(1024*1024);
    if (sizeMB < 1 || sizeMB > 5){ say('err','File must be between 1 MB and 5 MB.'); return; }
    if (!$('consent').checked){ say('err','Please agree to the consent.'); return; }

    btn.disabled = true; say('warn','Uploading…'); setBar(5);

    // 1) try multipart (simple request, no preflight)
    try{
      const fd = new FormData();
      fd.append('name', $('name').value.trim());
      fd.append('email', $('email').value.trim());
      fd.append('title', $('title').value.trim());
      fd.append('description', $('description').value.trim());
      fd.append('consent', $('consent').checked ? 'true' : 'false');
      fd.append('file', file, file.name);

      const r = await fetch(SCRIPT_URL, { method:'POST', body: fd });
      setBar(70);
      if (!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();

      if (j.ok){
        setBar(100); say('ok','Upload successful.');
        e.target.reset(); $('fname').textContent='no file selected'; setTimeout(()=>setBar(0), 900);
        refreshCount(); loadRecent();
        btn.disabled = false; return;
      }
      throw new Error(j.error || 'Server refused');
    }catch(err){
      // 2) fallback: base64 (for strict networks)
      say('warn','Network is blocking cross-origin upload. Using safe fallback…'); setBar(30);
      try{
        const b64 = await fileToBase64(file);
        const fd2 = new FormData();
        fd2.append('name', $('name').value.trim());
        fd2.append('email', $('email').value.trim());
        fd2.append('title', $('title').value.trim());
        fd2.append('description', $('description').value.trim());
        fd2.append('consent', $('consent').checked ? 'true' : 'false');
        fd2.append('filebase64', b64);
        fd2.append('mimetype', file.type || 'application/octet-stream');
        fd2.append('filename', file.name || 'upload.bin');

        const r2 = await fetch(SCRIPT_URL, { method:'POST', body: fd2 });
        setBar(85);
        if (!r2.ok) throw new Error('HTTP '+r2.status);
        const j2 = await r2.json();

        if (j2.ok){
          setBar(100); say('ok','Upload sent. Waiting for confirmation…');
          e.target.reset(); $('fname').textContent='no file selected'; setTimeout(()=>setBar(0), 900);
          refreshCount(); loadRecent();
        }else{
          say('err','Upload failed: ' + (j2.error || 'Unknown error'));
        }
      }catch(err2){
        say('err','Upload failed: ' + (err2.message || err2));
      }finally{
        btn.disabled = false;
      }
    }
  });

  // init
  refreshCount();
  loadRecent();
</script>
</body>
</html>
