<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fancy Pony — Artwork Submission</title>
<style>
  :root{
    --brand:#2563eb;
    --brand-600:#1d4ed8;
    --ok:#16a34a;
    --warn:#b45309;
    --err:#b91c1c;
    --ink:#0f172a;
    --muted:#6b7280;
    --card-bg: rgba(255,255,255,0.92);
  }
  html,body{height:100%}
  body{
    margin:0; font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    color:var(--ink);
    background-image:url('https://i.postimg.cc/jSmGH445/Pony.png');
    background-repeat: repeat;
    background-size: 220px auto;
    background-attachment: fixed;
  }
  /* 背景版權文字 */
  .bg-credit{
    position:fixed;
    bottom:8px;
    left:50%;
    transform:translateX(-50%);
    font-size:12px;
    color:#444;
    background:rgba(255,255,255,0.5);
    padding:3px 8px;
    border-radius:6px;
    pointer-events:none;
  }
  .wrap{
    max-width: 900px;
    margin: 32px auto;
    padding: 20px 18px;
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: 0 6px 20px rgba(0,0,0,.08);
  }
  h1{margin:0 0 4px 0; font-size: clamp(22px,4.5vw,36px); letter-spacing:.3px}
  .grid{display:block}
  .field{margin:14px 0}
  label{display:block; font-weight:700; margin-bottom:6px}
  input[type="text"], input[type="email"], textarea{
    width:100%; box-sizing:border-box;
    padding:10px 14px; margin:8px 0;
    border:1px solid #e5e7eb; border-radius:12px; background:#fff; font-size:1rem;
  }
  textarea{min-height:80px; resize:vertical}
  .file-row{display:flex; align-items:center; gap:12px}
  .file-wrap{position:relative; display:inline-block}
  .file-wrap input[type="file"]{position:absolute; inset:0; opacity:0; cursor:pointer;}
  .btn-file{
    display:inline-block; padding:10px 16px; border-radius:12px;
    background:var(--brand); color:#fff; font-weight:800; border:none; cursor:pointer;
  }
  .file-name{font-size:14px; color:var(--muted)}
  .agree{display:flex; gap:10px; align-items:flex-start; margin:18px 0}
  .btn{
    display:inline-block; padding:12px 18px; border-radius:14px; border:none;
    background:var(--brand); color:#fff; font-weight:900; cursor:pointer;
  }
  .bar{height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; margin-top:12px}
  .bar > i{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--brand), var(--ok)); transition:width .2s ease}
  .status{margin:12px 0 6px 0; font-weight:700}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  .panel{margin-top:26px; padding:18px; background:var(--card-bg); border-radius:16px}
  .panel-header{display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center;}
  .panel-header h2{margin:0; font-size:26px}
  .panel-info{color:var(--muted); font-weight:600; margin-top:4px}
  .actions{display:flex; gap:12px; align-items:center;}
  .a{color:var(--brand); text-decoration:none; font-weight:800}
  .a:hover{text-decoration:underline}
  .list{display:flex; flex-direction:column; gap:10px}
  .item{padding:12px 12px; border:1px solid #e5e7eb; border-radius:12px; background:#fff;}
  .ttl{font-weight:800}
  .sub{font-size:13px; color:var(--muted)}
  .desc{margin-top:4px; white-space:pre-wrap}
  .pair{display:flex; align-items:baseline; gap:8px}
</style>
</head>
<body>
<main class="wrap">
  <h1>Fancy Pony — Artwork Submission</h1>

  <form id="form" class="grid" novalidate>
    <div class="field">
      <label for="name">Your Name *</label>
      <input id="name" name="name" type="text" required>
    </div>
    <div class="field">
      <label for="email">Your Email *</label>
      <input id="email" name="email" type="email" required>
    </div>
    <div class="field">
      <label for="title">Pony Name *</label>
      <input id="title" name="title" type="text" required>
    </div>
    <div class="field">
      <label>Upload File *</label>
      <div class="file-row">
        <span class="file-wrap">
          <button class="btn-file" type="button">Choose File</button>
          <input id="file" name="file" type="file" accept=".jpg,.jpeg,.png,.pdf" required>
        </span>
        <span id="fname" class="file-name">no file selected</span>
      </div>
    </div>
    <div class="field">
      <label for="description">Description (optional)</label>
      <textarea id="description" name="description"></textarea>
    </div>
    <div class="agree">
      <input id="consent" name="consent" type="checkbox" value="true" required>
      <label for="consent">I agree to grant the school marketing rights to use my artwork.</label>
    </div>
    <div class="pair">
      <button id="submitBtn" class="btn" type="submit">Upload</button>
      <div id="status" class="status"></div>
    </div>
    <div class="bar"><i id="bar"></i></div>
    <div id="pct" class="sub">0%</div>
  </form>

  <section class="panel">
    <div class="panel-header">
      <h2>Recent submissions</h2>
      <div class="actions">
        <span class="panel-info">Total drawings collected: <span id="count">–</span></span>
        <a class="a" href="#" id="refresh">refresh</a>
      </div>
    </div>
    <div id="list" class="list">
      <div class="item">Loading…</div>
    </div>
  </section>
</main>

<!-- 背景版權提示 -->
<div class="bg-credit">Background image designed by Demi Tai</div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzqnplLlJsrf1rgLQmocmeLOTmyub-tj6jNeaMscqG5v7QfxuDZ_sR-D8sjLv3fDPkO_w/exec';
const $ = id => document.getElementById(id);
function setBar(n){ $('bar').style.width = Math.max(0, Math.min(100, n)) + '%'; $('pct').textContent = Math.round(n) + '%'; }
function say(cls, msg){ const el=$('status'); el.className='status '+(cls||''); el.textContent = msg || ''; }
function timeStr(v){ try{ const d = new Date(v); return d.toLocaleString(); }catch{ return ''; } }
$('file').addEventListener('change', e=> $('fname').textContent = e.target.files[0]?.name || 'no file selected');
async function refreshCount(){ try{ const r = await fetch(SCRIPT_URL + '?action=count'); const j = await r.json(); $('count').textContent = j.ok ? (j.count ?? 0) : '–'; }catch{ $('count').textContent = '–'; } }
async function loadRecent(){
  const box = $('list'); box.innerHTML = '<div class="item">Loading…</div>';
  try{
    const r = await fetch(SCRIPT_URL + '?action=recent&limit=12'); const j = await r.json();
    if (!j.ok) throw new Error(j.error);
    if (!j.items.length){ box.innerHTML = '<div class="item">No items yet.</div>'; return; }
    box.innerHTML = '';
    for (const it of j.items){
      const title = (it.title||'').trim() || 'Untitled';
      const name  = (it.name||'').trim() || 'Anonymous';
      const ts    = timeStr(it.timestamp);
      const desc  = (it.description||'').trim();
      const url   = (it.fileUrl||'').trim();
      const row = document.createElement('div'); row.className='item';
      row.innerHTML = `<div class="ttl">${url?`<a class="a" target="_blank" href="${url}">${title}</a>`:title}</div>
                       <div class="sub">${ts} • ${name}</div>
                       ${desc?`<div class="desc">${desc}</div>`:''}`;
      box.appendChild(row);
    }
  }catch(err){ box.innerHTML = `<div class="item">Failed to load. <span class="sub">${err.message}</span></div>`; }
}
$('refresh').addEventListener('click', e=>{ e.preventDefault(); loadRecent(); });
async function fileToBase64(file){
  return new Promise((res,rej)=>{
    const fr=new FileReader(); fr.onload=()=>{const s=fr.result;res(s.split('base64,')[1]);}; fr.onerror=()=>rej(fr.error); fr.readAsDataURL(file);
  });
}
$('form').addEventListener('submit', async e=>{
  e.preventDefault(); const btn=$('submitBtn'); const file=$('file').files[0];
  setBar(0); say('', '');
  if (!file){ say('err','Please choose a file.'); return; }
  const sizeMB=file.size/(1024*1024); if (sizeMB<1||sizeMB>5){ say('err','File must be between 1 MB and 5 MB.'); return; }
  if (!$('consent').checked){ say('err','Please agree to the consent.'); return; }
  btn.disabled=true; say('warn','Uploading…'); setBar(5);
  try{
    const fd=new FormData(); ['name','email','title','description','consent'].forEach(k=>fd.append(k,$(k).type==='checkbox'?($(k).checked?'true':'false'):$(k).value.trim()));
    fd.append('file',file,file.name);
    const r=await fetch(SCRIPT_URL,{method:'POST',body:fd}); setBar(70);
    const j=await r.json(); if(j.ok){ setBar(100); say('ok','Upload successful.'); e.target.reset(); $('fname').textContent='no file selected'; refreshCount(); loadRecent();}
    else throw new Error(j.error);
  }catch(err){
    try{
      const b64=await fileToBase64(file); const fd2=new FormData();
      ['name','email','title','description','consent'].forEach(k=>fd2.append(k,$(k).type==='checkbox'?($(k).checked?'true':'false'):$(k).value.trim()));
      fd2.append('filebase64',b64); fd2.append('mimetype',file.type); fd2.append('filename',file.name);
      const r2=await fetch(SCRIPT_URL,{method:'POST',body:fd2}); const j2=await r2.json();
      if(j2.ok){ setBar(100); say('ok','Upload sent.'); e.target.reset(); $('fname').textContent='no file selected'; refreshCount(); loadRecent(); }
      else throw new Error(j2.error);
    }catch(err2){ say('err','Upload failed: '+err2.message); }
  }finally{ btn.disabled=false; }
});
refreshCount(); loadRecent();
</script>
</body>
</html>
